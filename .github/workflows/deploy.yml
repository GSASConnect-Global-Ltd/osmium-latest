# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Setup Node.js
#       uses: actions/setup-node@v3
#       with:
#         node-version: '18'
#         cache: 'npm'

#     - name: Install dependencies
#       run: npm ci

#     - name: Run tests (if you have any)
#       run: npm test --if-present

#     - name: Build application
#       run: npm run build

#     - name: Deploy to VPS
#       uses: appleboy/ssh-action@v0.1.6
#       with:
#         host: ${{ secrets.VPS_IP }}
#         username: ${{ secrets.VPS_USER }}
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         # script: |
#         #   cd /var/www/orrel-app
#         #   git pull origin main
#         #   npm ci --production
#         #   npm run build
#         #   pm2 restart ecosystem.config.js
#         #   echo "Deployment completed successfully!"
#         script: |
#             cd /var/www/orrel-app && ./deploy.sh


# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     timeout-minutes: 15
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Setup Node.js
#       uses: actions/setup-node@v3
#       with:
#         node-version: '18'
#         cache: 'npm'

#     - name: Install dependencies
#       run: npm ci

#     - name: Create environment file for build
#       run: |
#         # Create a temporary .env.local for build
#         echo "Creating .env.local for build..."
#         cat > .env.local << EOF
#         # Environment variables needed for build
#         NODE_ENV=production
#         NEXT_PUBLIC_API_BASE_URL=http://localhost:5000
#         # OPENAI_API_KEY is only needed if you use OpenAI during build
#         # If not, you can omit it or use a dummy value
#         EOF
        
#         # Add OPENAI_API_KEY only if it's needed for build
#         if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
#           echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env.local
#         fi

#     - name: Run linting (optional but recommended)
#       run: npm run lint --if-present || true

#     - name: Build application
#       run: npm run build

#     - name: Deploy to VPS
#       uses: appleboy/ssh-action@v0.1.6
#       with:
#         host: ${{ secrets.VPS_IP }}
#         username: ${{ secrets.VPS_USER }}
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script: |
#           set -e  # Exit on error
#           cd /var/www/orrel-app
          
#           echo "ðŸ“¥ Pulling latest code..."
#           git pull origin main
          
#           echo "ðŸ”§ Installing dependencies..."
#           npm ci --omit=dev
          
#           echo "âš™ï¸ Setting up environment..."
#           # Create or update .env.local on server
#           cat > .env.local << 'EOF'
#           NODE_ENV=production
#           PORT=8006
#           NEXT_PUBLIC_API_BASE_URL=http://localhost:5000
#           # OPENAI_API_KEY will be added from secrets below
#           EOF
          
#           # Add secret environment variables
#           echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env.local
          
#           echo "ðŸ—ï¸ Building application..."
#           npm run build
          
#           echo "ðŸ”„ Restarting PM2..."
#           # Use the fixed ecosystem.config.js
#           pm2 delete orrel-app 2>/dev/null || true
#           pm2 start ecosystem.config.js
          
#           echo "ðŸ’¾ Saving PM2 process list..."
#           pm2 save
          
#           echo "âœ… Deployment completed successfully!"
#           echo "ðŸ“Š Check status with: pm2 status"

# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Deploy via SSH
#       uses: appleboy/ssh-action@v0.1.6
#       with:
#         host: ${{ secrets.VPS_IP }}
#         username: ${{ secrets.VPS_USER }}
#         port: 22222
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script: |
#           cd /var/www/orrel-app
#           git pull origin main
#           npm ci --omit=dev
          
#           # Create .env.local with OpenAI key
#           cat > .env.local << EOF
#           NODE_ENV=production
#           PORT=8006
#           # NEXT_PUBLIC_API_BASE_URL=http://localhost:5000
#           OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
#           EOF
          
#           npm run build
#           pm2 restart ecosystem.config.js

# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Setup SSH
#       uses: webfactory/ssh-agent@v0.7.0
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
#     - name: Add VPS to known_hosts
#       run: |
#         # mkdir -p ~/.ssh
#         ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts
    
#     - name: Deploy
#       run: |
#         ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           cd /var/www/orrel-app
#           git pull origin main
#           npm ci --omit=dev
          
#           # Create .env.local with OpenAI key
#           # cat > .env.local << 'EOF'
#           NODE_ENV=production
#           PORT=8006
#           # NEXT_PUBLIC_API_BASE_URL=http://localhost:5000
#           OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
#           EOF
          
#           npm run build
#           pm2 restart ecosystem.config.js
#         "

# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Setup SSH
#       uses: webfactory/ssh-agent@v0.7.0
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
#     - name: Add VPS to known_hosts
#       run: |
#         mkdir -p ~/.ssh
#         ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts
    
#     - name: Deploy
#       run: |
#         ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           set -e
#           cd /var/www/orrel-app
          
#           echo 'Resetting git changes...'
#           git reset --hard HEAD
#           git clean -fd
          
#           echo 'Pulling latest code...'
#           git fetch origin
#           git checkout main
#           git reset --hard origin/main
          
#           echo 'Installing dependencies...'
#           npm ci --omit=dev
          
#           echo 'Creating environment file...'
#           # Simple echo instead of cat with EOF
#           echo 'NODE_ENV=production' > .env.local
#           echo 'PORT=8006' >> .env.local
#           echo 'OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}' >> .env.local
          
#           echo 'Building application...'
#           npm run build
          
#           echo 'Restarting PM2...'
#           pm2 restart ecosystem.config.js
          
#           echo 'âœ… Deployment complete!'
#         "


# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Setup SSH
#       uses: webfactory/ssh-agent@v0.7.0
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
#     - name: Add VPS to known_hosts
#       run: |
#         mkdir -p ~/.ssh
#         ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts
    
#     - name: Deploy
#       run: |
#         ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           set -e
#           cd /var/www/orrel-app
          
#           echo 'Resetting git changes...'
#           git reset --hard HEAD
#           git clean -fd
          
#           echo 'Pulling latest code...'
#           git fetch origin
#           git checkout main
#           git reset --hard origin/main
          
#           echo 'Installing dependencies (including dev dependencies)...'
#           # Remove --omit=dev to include TypeScript
#           npm ci
          
#           echo 'Creating environment file...'
#           echo 'NODE_ENV=production' > .env.local
#           echo 'PORT=8006' >> .env.local
#           echo 'OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}' >> .env.local
          
#           echo 'Building application...'
#           npm run build
          
#           echo 'Restarting PM2...'
#           pm2 restart ecosystem.config.js
          
#           echo 'âœ… Deployment complete!'
#         "


# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main  # Only main branch

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy to VPS
#         run: |
#           set -e
          
#           ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#             set -e
            
#             echo 'ðŸš€ ========== STARTING DEPLOYMENT =========='
            
#             # Changed to orrelng.com directory
#             DEPLOY_DIR=\"/var/www/orrelng.com\"
            
#             if [ ! -d \"\$DEPLOY_DIR\" ]; then
#               echo 'ðŸ“ Creating deployment directory...'
#               sudo mkdir -p \"\$DEPLOY_DIR\"
#               # sudo chown -R gsas-admin:gsas-admin /var/www/orrelng.com
#               # sudo chmod 755 /var/www/orrelng.com
#               sudo chown -R $USER:$USER \"\$DEPLOY_DIR\"
#             fi
            
#             cd \"\$DEPLOY_DIR\"
            
#             echo 'ðŸ“‚ Current directory:'
#             pwd
            
#             # Initialize git if needed
#             if [ ! -d .git ]; then
#               echo 'ðŸ”§ Initializing git repository...'
#               git init
#               git remote add origin https://github.com/${{ github.repository }}.git
#             fi
            
#             # Fetch and reset to latest code (always main branch)
#             echo 'â¬‡ï¸ Fetching latest code from main branch...'
#             git fetch origin
#             git reset --hard origin/main  # Always use main branch
            
#             echo 'ðŸ“ Latest commit:'
#             git log --oneline -1
            
#             # ===== CRITICAL FIX: INSTALL DEPENDENCIES BEFORE CHECKING FILES =====
#             echo 'ðŸ“¦ Installing ALL dependencies...'
#             npm ci
            
#             echo 'ðŸ” Checking TypeScript configuration...'
#             if [ -f tsconfig.json ]; then
#               echo 'ðŸ“„ tsconfig.json found:'
#               cat tsconfig.json | grep -A 10 '"paths"'
#             elif [ -f jsconfig.json ]; then
#               echo 'ðŸ“„ jsconfig.json found:'
#               cat jsconfig.json | grep -A 10 '"paths"'
#             else
#               echo 'âš ï¸ No TypeScript/JavaScript config found!'
#             fi
            
#             echo 'ðŸ” Checking if @/lib directory exists...'
#             find . -type d -name "lib" | head -5
#             ls -la ./lib/ 2>/dev/null || echo 'No ./lib directory'
#             ls -la ./src/lib/ 2>/dev/null || echo 'No ./src/lib directory'
            
#             echo 'ðŸš€ Deploying PRODUCTION environment (main branch only)...'
            
#             # SIMPLIFIED: Use only .env file
#             if [ -f .env ]; then
#               echo 'ðŸ“„ Using .env file'
#               cp .env .env.local
#             else
#               echo 'âš ï¸ Warning: .env file not found!'
#             fi
            
#             # Build for production
#             echo 'ðŸ—ï¸ Building application for production...'
#             NODE_ENV=production npm run build  # Assuming your build script is 'build'
            
#             # Restart PM2 process with orrelng.com name
#             echo 'ðŸ”„ Managing PM2 production process...'
#             pm2 delete orrelng.com 2>/dev/null || true
#             pm2 start npm --name \"orrelng.com\" -- run start -- -p 8006  # Assuming start script is 'start'
            
#             pm2 save
            
#             echo 'ðŸŒ Reloading nginx for orrelng.com...'
#             sudo systemctl reload nginx
            
#             echo 'âœ… ========== DEPLOYMENT COMPLETE =========='
#           "


# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Update Code
#         run: |
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             cd /var/www/orrelng.com || (sudo mkdir -p /var/www/orrelng.com && sudo chown gsas-admin:gsas-admin /var/www/orrelng.com && cd /var/www/orrelng.com)
#             git pull origin main || git clone https://github.com/${{ github.repository }}.git .
#           "

#       - name: Install and Build
#         run: |
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             cd /var/www/orrelng.com
#             npm install --no-optional
#             npm run build
#           "

#       - name: Start Application
#         run: |
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             cd /var/www/orrelng.com
#             pm2 delete orrelng.com 2>/dev/null || true
#             PORT=8006 pm2 start npm --name 'orrelng.com' -- start
#             sudo systemctl reload nginx
#           "

# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Deploy
#         run: |
#           # Add to known_hosts
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts
          
#           # Deploy in one go with keepalive
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             set -e
            
#             echo 'ðŸš€ Starting deployment...'
            
#             # Setup directory
#             sudo mkdir -p /var/www/orrelng.com
#             sudo chown -R gsas-admin:gsas-admin /var/www/orrelng.com
            
#             cd /var/www/orrelng.com
            
#             # Update code
#             if [ -d .git ]; then
#               git pull origin main
#             else
#               git clone https://github.com/${{ github.repository }}.git .
#             fi
            
#             # Install and build
#             echo 'ðŸ“¦ Installing dependencies...'
#             npm install --no-optional
            
#             echo 'ðŸ—ï¸ Building...'
#             npm run build
            
#             # Start app
#             echo 'ðŸ”„ Starting application...'
#             pm2 delete orrelng.com 2>/dev/null || true
#             PORT=8006 pm2 start npm --name 'orrelng.com' -- start
#             pm2 save
            
#             # Reload nginx
#             sudo systemctl reload nginx
            
#             echo 'âœ… Deployment complete!'
#           "

# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy
#         run: |
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             set -e
            
#             echo 'ðŸš€ Starting deployment...'
            
#             # Setup directory
#             DEPLOY_DIR=\"/var/www/orrelng.com\"
#             sudo mkdir -p \"\$DEPLOY_DIR\"
#             sudo chown -R gsas-admin:gsas-admin \"\$DEPLOY_DIR\"
            
#             cd \"\$DEPLOY_DIR\"
            
#             echo 'ðŸ—‘ï¸ Cleaning previous build...'
#             rm -rf .next node_modules package-lock.json
            
#             echo 'ðŸ“¥ Cloning fresh code...'
#             git clone https://github.com/${{ github.repository }}.git . 2>/dev/null || git pull origin main
            
#             echo 'ðŸ“¦ Installing dependencies with exact versions...'
#             # Force clean install
#             npm cache clean --force
#             npm install --legacy-peer-deps
            
#             echo 'ðŸ”§ Checking architecture...'
#             echo \"Node version: \$(node --version)\"
#             echo \"NPM version: \$(npm --version)\"
#             echo \"Architecture: \$(uname -m)\"
#             echo \"Kernel: \$(uname -s)\"
            
#             echo 'ðŸ—ï¸ Building for production on VPS...'
#             # Clear Next.js cache
#             rm -rf /home/gsas-admin/.cache/next-swc
            
#             # Set environment and build
#             NODE_ENV=production npm run build
            
#             echo 'âœ… Build complete!'
            
#             echo 'ðŸ”„ Restarting application...'
#             pm2 delete orrelng.com 2>/dev/null || true
#             PORT=3000 pm2 start npm --name 'orrelng.com' -- start
#             pm2 save
            
#             echo 'ðŸŒ Reloading nginx...'
#             sudo systemctl reload nginx
            
#             echo 'ðŸŽ‰ Deployment complete!'
#           "

# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy
#         run: |
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             set -e
            
#             echo 'ðŸš€ Starting deployment...'
            
#             # Setup directory
#             DEPLOY_DIR=\"/var/www/orrelng.com\"
#             sudo mkdir -p \"\$DEPLOY_DIR\"
#             sudo chown -R gsas-admin:gsas-admin \"\$DEPLOY_DIR\"
            
#             cd \"\$DEPLOY_DIR\"
            
#             echo 'ðŸ“¥ Cloning/updating code...'
#             if [ -d .git ]; then
#               git pull origin main
#             else
#               git clone https://github.com/${{ github.repository }}.git .
#             fi
            
#             echo 'ðŸ“¦ Installing dependencies...'
#             npm install --legacy-peer-deps
            
#             echo 'ðŸ”§ Setting up environment...'
#             # Create .env file with required variables
#             cat > .env.local << 'EOF'
#             PORT=8006
#             OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
#             NODE_ENV=production
#             EOF
            
#             # Also create .env for build
#             cp .env.local .env
            
#             echo 'ðŸ—ï¸ Building application...'
#             NODE_ENV=production npm run build
            
#             echo 'ðŸš€ Starting application...'
#             pm2 delete orrelng.com 2>/dev/null || true
#             pm2 start npm --name 'orrelng.com' -- start
            
#             echo 'âœ… Deployment complete!'
#           "

# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy
#         run: |
#           # Single SSH command with simple commands
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             set -e
#             echo 'ðŸš€ Starting deployment...'
            
#             # Setup
#             sudo mkdir -p /var/www/orrelng.com
#             sudo chown -R gsas-admin:gsas-admin /var/www/orrelng.com
#             cd /var/www/orrelng.com
            
#             # Update code
#             if [ -d .git ]; then
#               git pull origin main
#             else
#               git clone https://github.com/${{ github.repository }}.git .
#             fi
            
#             # Install
#             npm install --legacy-peer-deps
            
#             # Environment
#             echo 'PORT=8006' > .env
#             echo 'NODE_ENV=production' >> .env
#             cp .env .env.local
            
#             # Build
#             NODE_ENV=production npm run build
            
#             # Start
#             pm2 delete orrelng.com 2>/dev/null || true
#             pm2 start npm --name 'orrelng.com' -- start -- -p 8006
            
#             echo 'âœ… Done!'
#           "


# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy to VPS
#         run: |
#           set -e
          
#           ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#             set -e
            
#             echo 'ðŸš€ ========== STARTING DEPLOYMENT =========='
            
#             DEPLOY_DIR=\"/var/www/orrelng.com\"
            
#             if [ ! -d \"\$DEPLOY_DIR\" ]; then
#               echo 'ðŸ“ Creating deployment directory...'
#               sudo mkdir -p \"\$DEPLOY_DIR\"
#               sudo chown -R $USER:$USER \"\$DEPLOY_DIR\"
#             fi
            
#             cd \"\$DEPLOY_DIR\"
            
#             echo 'ðŸ“‚ Current directory:'
#             pwd
            
#             # Initialize git if needed
#             if [ ! -d .git ]; then
#               echo 'ðŸ”§ Initializing git repository...'
#               git init
#               git remote add origin https://github.com/${{ github.repository }}.git
#             fi
            
#             # Fetch and reset to latest code
#             echo 'â¬‡ï¸ Fetching latest code...'
#             git fetch origin
#             git reset --hard origin/main
            
#             echo 'ðŸ“ Latest commit:'
#             git log --oneline -1
            
#             echo 'ðŸ“¦ Installing dependencies...'
#             npm ci
            
#             echo 'ðŸ—ï¸ Building application...'
            
#             # SIMPLIFIED: Use only .env file
#             if [ -f .env ]; then
#               echo 'ðŸ“„ Using .env file'
#               cp .env .env.local
#             else
#               echo 'âš ï¸ Warning: .env file not found!'
#               echo 'PORT=8006' > .env.local
#             fi
            
#             # Build for production
#             echo 'ðŸš€ Building for production...'
#             NODE_ENV=production npm run build
            
#             # Restart PM2 process
#             echo 'ðŸ”„ Managing PM2 process...'
#             pm2 delete orrelng.com 2>/dev/null || true
#             pm2 start npm --name \"orrelng.com\" -- start 
            
#             pm2 save
            
#             echo 'ðŸŒ Reloading nginx...'
#             sudo systemctl reload nginx
            
#             echo 'âœ… ========== DEPLOYMENT COMPLETE =========='
#           "

# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Test SSH connection
#         run: |
#           ssh -p 22222 -T ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "echo 'SSH connection successful'"

#       - name: Deploy to VPS
#         run: |
#           ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} '
#             set -e
#             echo "ðŸš€ Starting deployment..."
            
#             DEPLOY_DIR="/var/www/orrelng.com"
            
#             # Setup directory
#             sudo mkdir -p "$DEPLOY_DIR"
#             sudo chown -R $USER:$USER "$DEPLOY_DIR"
            
#             cd "$DEPLOY_DIR"
            
#             # Get latest code
#             if [ -d .git ]; then
#               git pull origin main
#             else
#               git clone https://github.com/${{ github.repository }}.git .
#             fi
            
#             # Install dependencies
#             npm ci
            
#             # Create environment file
#             cat > .env.local << END
#             PORT=3000
#             NODE_ENV=production
#             END
            
#             # Build
#             npm run build
            
#             # Start with PM2
#             pm2 delete orrelng.com 2>/dev/null || true
#             pm2 start npm --name "orrelng.com" -- start -- -p 8006
            
            
#             echo "âœ… Deployment complete!"
#           '

name: Deploy to orrelng.com

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VPS_IP }}
          username: gsas-admin
          port: 22222
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "ðŸš€ Deploying to orrelng.com..."
            
            # Setup directory
            DEPLOY_DIR="/var/www/orrelng.com"
            sudo mkdir -p "$DEPLOY_DIR"
            sudo chown -R gsas-admin:gsas-admin "$DEPLOY_DIR"
            
            cd "$DEPLOY_DIR"
            
            # Update code
            if [ -d .git ]; then
              git pull origin main
            else
              git clone https://github.com/${{ github.repository }}.git .
            fi
            
            # Install dependencies
            npm ci
            
            # Create .env.local with OpenAI key from secret
            cat > .env.local << 'EOF'
            PORT=8006
            NODE_ENV=production
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            EOF
            
            # Build
            timeout 300 npm run build || {
              echo "âš ï¸ Build timed out, trying with less memory..."
              NODE_OPTIONS="--max-old-space-size=4096" npm run build
            }
            
            # Start with PM2
            pm2 delete orrelng.com 2>/dev/null || true
            pm2 start npm --name "orrelng.com" -- start -- -p 8006
            
            # Reload nginx
            sudo systemctl reload nginx
            
            echo "âœ… Deployment complete!"