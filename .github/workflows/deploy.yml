# name: Deploy to Production
# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Setup Node.js
#       uses: actions/setup-node@v3
#       with:
#         node-version: '18'
#         cache: 'npm'

#     - name: Install dependencies
#       run: npm ci

#     - name: Run tests (if you have any)
#       run: npm test --if-present

#     - name: Build application
#       run: npm run build


# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     timeout-minutes: 15
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Setup Node.js
#       uses: actions/setup-node@v3
#       with:
#         node-version: '18'
#         cache: 'npm'

#     - name: Install dependencies
#       run: npm ci

#     - name: Create environment file for build
#       run: |
#         # Create a temporary .env.local for build
#         echo "Creating .env.local for build..."
#         cat > .env.local << EOF
#         # Environment variables needed for build
#         NODE_ENV=production
#         NEXT_PUBLIC_API_BASE_URL=http://localhost:5000
#         # OPENAI_API_KEY is only needed if you use OpenAI during build
#         # If not, you can omit it or use a dummy value
#         EOF
        
#         # Add OPENAI_API_KEY only if it's needed for build
#         if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
#           echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env.local
#         fi

#     - name: Run linting (optional but recommended)
#       run: npm run lint --if-present || true

#     - name: Build application
#       run: npm run build

#     - name: Deploy to VPS
#       uses: appleboy/ssh-action@v0.1.6
#       with:
#         host: ${{ secrets.VPS_IP }}
#         username: ${{ secrets.VPS_USER }}
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script: |
#           set -e  # Exit on error
#           cd /var/www/orrel-app
          
#           echo "ðŸ“¥ Pulling latest code..."
#           git pull origin main
          
#           echo "ðŸ”§ Installing dependencies..."
#           npm ci --omit=dev
          
#           echo "âš™ï¸ Setting up environment..."
#           # Create or update .env.local on server
#           cat > .env.local << 'EOF'
#           NODE_ENV=production
#           PORT=8006
#           NEXT_PUBLIC_API_BASE_URL=http://localhost:5000
#           # OPENAI_API_KEY will be added from secrets below
#           EOF
          
#           # Add secret environment variables
#           echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env.local
          
#           echo "ðŸ—ï¸ Building application..."
#           npm run build
          
#           echo "ðŸ”„ Restarting PM2..."
#           # Use the fixed ecosystem.config.js
#           pm2 delete orrel-app 2>/dev/null || true
#           pm2 start ecosystem.config.js
          
#           echo "ðŸ’¾ Saving PM2 process list..."
#           pm2 save
          
#           echo "âœ… Deployment completed successfully!"
#           echo "ðŸ“Š Check status with: pm2 status"

# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Deploy via SSH
#       uses: appleboy/ssh-action@v0.1.6
#       with:
#         host: ${{ secrets.VPS_IP }}
#         username: ${{ secrets.VPS_USER }}
#         port: 22222
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script: |
#           cd /var/www/orrel-app
#           git pull origin main
#           npm ci --omit=dev
          
#           # Create .env.local with OpenAI key
#           cat > .env.local << EOF
#           NODE_ENV=production
#           PORT=8006
#           # NEXT_PUBLIC_API_BASE_URL=http://localhost:5000
#           OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
#           EOF
          
#           npm run build
#           pm2 restart ecosystem.config.js

# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Setup SSH
#       uses: webfactory/ssh-agent@v0.7.0
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
#     - name: Add VPS to known_hosts
#       run: |
#         # mkdir -p ~/.ssh
#         ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts
    
#     - name: Deploy
#       run: |
#         ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           cd /var/www/orrel-app
#           git pull origin main
#           npm ci --omit=dev
          
#           # Create .env.local with OpenAI key
#           # cat > .env.local << 'EOF'
#           NODE_ENV=production
#           PORT=8006
#           # NEXT_PUBLIC_API_BASE_URL=http://localhost:5000
#           OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
#           EOF
          
#           npm run build
#           pm2 restart ecosystem.config.js
#         "

# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Setup SSH
#       uses: webfactory/ssh-agent@v0.7.0
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
#     - name: Add VPS to known_hosts
#       run: |
#         mkdir -p ~/.ssh
#         ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts
    
#     - name: Deploy
#       run: |
#         ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           set -e
#           cd /var/www/orrel-app
          
#           echo 'Resetting git changes...'
#           git reset --hard HEAD
#           git clean -fd
          
#           echo 'Pulling latest code...'
#           git fetch origin
#           git checkout main
#           git reset --hard origin/main
          
#           echo 'Installing dependencies...'
#           npm ci --omit=dev
          
#           echo 'Creating environment file...'
#           # Simple echo instead of cat with EOF
#           echo 'NODE_ENV=production' > .env.local
#           echo 'PORT=8006' >> .env.local
#           echo 'OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}' >> .env.local
          
#           echo 'Building application...'
#           npm run build
          
#           echo 'Restarting PM2...'
#           pm2 restart ecosystem.config.js
          
#           echo 'âœ… Deployment complete!'
#         "


# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Setup SSH
#       uses: webfactory/ssh-agent@v0.7.0
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
#     - name: Add VPS to known_hosts
#       run: |
#         mkdir -p ~/.ssh
#         ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts
    
#     - name: Deploy
#       run: |
#         ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           set -e
#           cd /var/www/orrel-app
          
#           echo 'Resetting git changes...'
#           git reset --hard HEAD
#           git clean -fd
          
#           echo 'Pulling latest code...'
#           git fetch origin
#           git checkout main
#           git reset --hard origin/main
          
#           echo 'Installing dependencies (including dev dependencies)...'
#           # Remove --omit=dev to include TypeScript
#           npm ci
          
#           echo 'Creating environment file...'
#           echo 'NODE_ENV=production' > .env.local
#           echo 'PORT=8006' >> .env.local
#           echo 'OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}' >> .env.local
          
#           echo 'Building application...'
#           npm run build
          
#           echo 'Restarting PM2...'
#           pm2 restart ecosystem.config.js
          
#           echo 'âœ… Deployment complete!'
#         "


# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main  # Only main branch

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy to VPS
#         run: |
#           set -e
          
#           ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#             set -e
            
#             echo 'ðŸš€ ========== STARTING DEPLOYMENT =========='
            
#             # Changed to orrelng.com directory
#             DEPLOY_DIR=\"/var/www/orrelng.com\"
            
#             if [ ! -d \"\$DEPLOY_DIR\" ]; then
#               echo 'ðŸ“ Creating deployment directory...'
#               sudo mkdir -p \"\$DEPLOY_DIR\"
#               # sudo chown -R gsas-admin:gsas-admin /var/www/orrelng.com
#               # sudo chmod 755 /var/www/orrelng.com
#               sudo chown -R $USER:$USER \"\$DEPLOY_DIR\"
#             fi
            
#             cd \"\$DEPLOY_DIR\"
            
#             echo 'ðŸ“‚ Current directory:'
#             pwd
            
#             # Initialize git if needed
#             if [ ! -d .git ]; then
#               echo 'ðŸ”§ Initializing git repository...'
#               git init
#               git remote add origin https://github.com/${{ github.repository }}.git
#             fi
            
#             # Fetch and reset to latest code (always main branch)
#             echo 'â¬‡ï¸ Fetching latest code from main branch...'
#             git fetch origin
#             git reset --hard origin/main  # Always use main branch
            
#             echo 'ðŸ“ Latest commit:'
#             git log --oneline -1
            
#             # ===== CRITICAL FIX: INSTALL DEPENDENCIES BEFORE CHECKING FILES =====
#             echo 'ðŸ“¦ Installing ALL dependencies...'
#             npm ci
            
#             echo 'ðŸ” Checking TypeScript configuration...'
#             if [ -f tsconfig.json ]; then
#               echo 'ðŸ“„ tsconfig.json found:'
#               cat tsconfig.json | grep -A 10 '"paths"'
#             elif [ -f jsconfig.json ]; then
#               echo 'ðŸ“„ jsconfig.json found:'
#               cat jsconfig.json | grep -A 10 '"paths"'
#             else
#               echo 'âš ï¸ No TypeScript/JavaScript config found!'
#             fi
            
#             echo 'ðŸ” Checking if @/lib directory exists...'
#             find . -type d -name "lib" | head -5
#             ls -la ./lib/ 2>/dev/null || echo 'No ./lib directory'
#             ls -la ./src/lib/ 2>/dev/null || echo 'No ./src/lib directory'
            
#             echo 'ðŸš€ Deploying PRODUCTION environment (main branch only)...'
            
#             # SIMPLIFIED: Use only .env file
#             if [ -f .env ]; then
#               echo 'ðŸ“„ Using .env file'
#               cp .env .env.local
#             else
#               echo 'âš ï¸ Warning: .env file not found!'
#             fi
            
#             # Build for production
#             echo 'ðŸ—ï¸ Building application for production...'
#             NODE_ENV=production npm run build  # Assuming your build script is 'build'
            
#             # Restart PM2 process with orrelng.com name
#             echo 'ðŸ”„ Managing PM2 production process...'
#             pm2 delete orrelng.com 2>/dev/null || true
#             pm2 start npm --name \"orrelng.com\" -- run start -- -p 8006  # Assuming start script is 'start'
            
#             pm2 save
            
#             echo 'ðŸŒ Reloading nginx for orrelng.com...'
#             sudo systemctl reload nginx
            
#             echo 'âœ… ========== DEPLOYMENT COMPLETE =========='
#           "


# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Update Code
#         run: |
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             cd /var/www/orrelng.com || (sudo mkdir -p /var/www/orrelng.com && sudo chown gsas-admin:gsas-admin /var/www/orrelng.com && cd /var/www/orrelng.com)
#             git pull origin main || git clone https://github.com/${{ github.repository }}.git .
#           "

#       - name: Install and Build
#         run: |
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             cd /var/www/orrelng.com
#             npm install --no-optional
#             npm run build
#           "

#       - name: Start Application
#         run: |
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             cd /var/www/orrelng.com
#             pm2 delete orrelng.com 2>/dev/null || true
#             PORT=8006 pm2 start npm --name 'orrelng.com' -- start
#             sudo systemctl reload nginx
#           "

# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Deploy
#         run: |
#           # Add to known_hosts
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts
          
#           # Deploy in one go with keepalive
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             set -e
            
#             echo 'ðŸš€ Starting deployment...'
            
#             # Setup directory
#             sudo mkdir -p /var/www/orrelng.com
#             sudo chown -R gsas-admin:gsas-admin /var/www/orrelng.com
            
#             cd /var/www/orrelng.com
            
#             # Update code
#             if [ -d .git ]; then
#               git pull origin main
#             else
#               git clone https://github.com/${{ github.repository }}.git .
#             fi
            
#             # Install and build
#             echo 'ðŸ“¦ Installing dependencies...'
#             npm install --no-optional
            
#             echo 'ðŸ—ï¸ Building...'
#             npm run build
            
#             # Start app
#             echo 'ðŸ”„ Starting application...'
#             pm2 delete orrelng.com 2>/dev/null || true
#             PORT=8006 pm2 start npm --name 'orrelng.com' -- start
#             pm2 save
            
#             # Reload nginx
#             sudo systemctl reload nginx
            
#             echo 'âœ… Deployment complete!'
#           "

# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy
#         run: |
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             set -e
            
#             echo 'ðŸš€ Starting deployment...'
            
#             # Setup directory
#             DEPLOY_DIR=\"/var/www/orrelng.com\"
#             sudo mkdir -p \"\$DEPLOY_DIR\"
#             sudo chown -R gsas-admin:gsas-admin \"\$DEPLOY_DIR\"
            
#             cd \"\$DEPLOY_DIR\"
            
#             echo 'ðŸ—‘ï¸ Cleaning previous build...'
#             rm -rf .next node_modules package-lock.json
            
#             echo 'ðŸ“¥ Cloning fresh code...'
#             git clone https://github.com/${{ github.repository }}.git . 2>/dev/null || git pull origin main
            
#             echo 'ðŸ“¦ Installing dependencies with exact versions...'
#             # Force clean install
#             npm cache clean --force
#             npm install --legacy-peer-deps
            
#             echo 'ðŸ”§ Checking architecture...'
#             echo \"Node version: \$(node --version)\"
#             echo \"NPM version: \$(npm --version)\"
#             echo \"Architecture: \$(uname -m)\"
#             echo \"Kernel: \$(uname -s)\"
            
#             echo 'ðŸ—ï¸ Building for production on VPS...'
#             # Clear Next.js cache
#             rm -rf /home/gsas-admin/.cache/next-swc
            
#             # Set environment and build
#             NODE_ENV=production npm run build
            
#             echo 'âœ… Build complete!'
            
#             echo 'ðŸ”„ Restarting application...'
#             pm2 delete orrelng.com 2>/dev/null || true
#             PORT=3000 pm2 start npm --name 'orrelng.com' -- start
#             pm2 save
            
#             echo 'ðŸŒ Reloading nginx...'
#             sudo systemctl reload nginx
            
#             echo 'ðŸŽ‰ Deployment complete!'
#           "

# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy
#         run: |
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             set -e
            
#             echo 'ðŸš€ Starting deployment...'
            
#             # Setup directory
#             DEPLOY_DIR=\"/var/www/orrelng.com\"
#             sudo mkdir -p \"\$DEPLOY_DIR\"
#             sudo chown -R gsas-admin:gsas-admin \"\$DEPLOY_DIR\"
            
#             cd \"\$DEPLOY_DIR\"
            
#             echo 'ðŸ“¥ Cloning/updating code...'
#             if [ -d .git ]; then
#               git pull origin main
#             else
#               git clone https://github.com/${{ github.repository }}.git .
#             fi
            
#             echo 'ðŸ“¦ Installing dependencies...'
#             npm install --legacy-peer-deps
            
#             echo 'ðŸ”§ Setting up environment...'
#             # Create .env file with required variables
#             cat > .env.local << 'EOF'
#             PORT=8006
#             OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
#             NODE_ENV=production
#             EOF
            
#             # Also create .env for build
#             cp .env.local .env
            
#             echo 'ðŸ—ï¸ Building application...'
#             NODE_ENV=production npm run build
            
#             echo 'ðŸš€ Starting application...'
#             pm2 delete orrelng.com 2>/dev/null || true
#             pm2 start npm --name 'orrelng.com' -- start
            
#             echo 'âœ… Deployment complete!'
#           "

# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy
#         run: |
#           # Single SSH command with simple commands
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             set -e
#             echo 'ðŸš€ Starting deployment...'
            
#             # Setup
#             sudo mkdir -p /var/www/orrelng.com
#             sudo chown -R gsas-admin:gsas-admin /var/www/orrelng.com
#             cd /var/www/orrelng.com
            
#             # Update code
#             if [ -d .git ]; then
#               git pull origin main
#             else
#               git clone https://github.com/${{ github.repository }}.git .
#             fi
            
#             # Install
#             npm install --legacy-peer-deps
            
#             # Environment
#             echo 'PORT=8006' > .env
#             echo 'NODE_ENV=production' >> .env
#             cp .env .env.local
            
#             # Build
#             NODE_ENV=production npm run build
            
#             # Start
#             pm2 delete orrelng.com 2>/dev/null || true
#             pm2 start npm --name 'orrelng.com' -- start -- -p 8006
            
#             echo 'âœ… Done!'
#           "


# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy to VPS
#         run: |
#           set -e
          
#           ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#             set -e
            
#             echo 'ðŸš€ ========== STARTING DEPLOYMENT =========='
            
#             DEPLOY_DIR=\"/var/www/orrelng.com\"
            
#             if [ ! -d \"\$DEPLOY_DIR\" ]; then
#               echo 'ðŸ“ Creating deployment directory...'
#               sudo mkdir -p \"\$DEPLOY_DIR\"
#               sudo chown -R $USER:$USER \"\$DEPLOY_DIR\"
#             fi
            
#             cd \"\$DEPLOY_DIR\"
            
#             echo 'ðŸ“‚ Current directory:'
#             pwd
            
#             # Initialize git if needed
#             if [ ! -d .git ]; then
#               echo 'ðŸ”§ Initializing git repository...'
#               git init
#               git remote add origin https://github.com/${{ github.repository }}.git
#             fi
            
#             # Fetch and reset to latest code
#             echo 'â¬‡ï¸ Fetching latest code...'
#             git fetch origin
#             git reset --hard origin/main
            
#             echo 'ðŸ“ Latest commit:'
#             git log --oneline -1
            
#             echo 'ðŸ“¦ Installing dependencies...'
#             npm ci
            
#             echo 'ðŸ—ï¸ Building application...'
            
#             # SIMPLIFIED: Use only .env file
#             if [ -f .env ]; then
#               echo 'ðŸ“„ Using .env file'
#               cp .env .env.local
#             else
#               echo 'âš ï¸ Warning: .env file not found!'
#               echo 'PORT=8006' > .env.local
#             fi
            
#             # Build for production
#             echo 'ðŸš€ Building for production...'
#             NODE_ENV=production npm run build
            
#             # Restart PM2 process
#             echo 'ðŸ”„ Managing PM2 process...'
#             pm2 delete orrelng.com 2>/dev/null || true
#             pm2 start npm --name \"orrelng.com\" -- start 
            
#             pm2 save
            
#             echo 'ðŸŒ Reloading nginx...'
#             sudo systemctl reload nginx
            
#             echo 'âœ… ========== DEPLOYMENT COMPLETE =========='
#           "

# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Test SSH connection
#         run: |
#           ssh -p 22222 -T ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "echo 'SSH connection successful'"

#       - name: Deploy to VPS
#         run: |
#           ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} '
#             set -e
#             echo "ðŸš€ Starting deployment..."
            
#             DEPLOY_DIR="/var/www/orrelng.com"
            
#             # Setup directory
#             sudo mkdir -p "$DEPLOY_DIR"
#             sudo chown -R $USER:$USER "$DEPLOY_DIR"
            
#             cd "$DEPLOY_DIR"
            
#             # Get latest code
#             if [ -d .git ]; then
#               git pull origin main
#             else
#               git clone https://github.com/${{ github.repository }}.git .
#             fi
            
#             # Install dependencies
#             npm ci
            
#             # Create environment file
#             cat > .env.local << END
#             PORT=3000
#             NODE_ENV=production
#             END
            
#             # Build
#             npm run build
            
#             # Start with PM2
#             pm2 delete orrelng.com 2>/dev/null || true
#             pm2 start npm --name "orrelng.com" -- start -- -p 8006
            
            
#             echo "âœ… Deployment complete!"
#           '

# name: Deploy to orrelng.com

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     timeout-minutes: 30

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy to VPS
#         run: |
#           # Use nohup to run commands in background
#           ssh -p 22222 -o ConnectTimeout=300 -o ServerAliveInterval=30 -o ServerAliveCountMax=3 gsas-admin@${{ secrets.VPS_IP }} "
#             set -e
#             echo 'ðŸš€ Starting deployment...'
            
#             cd /var/www/orrelng.com
            
#             # Quick code update
#             git pull origin main
            
#             # Install deps
#             npm ci
            
#             # Create env file
#             echo 'PORT=8006' > .env.local
#             echo 'NODE_ENV=production' >> .env.local
#             echo 'OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}' >> .env.local
            
#             # Build with timeout
#             timeout 300 npm run build || {
#               echo 'Build took too long, continuing anyway...'
#             }
            
#             # Start app
#             pm2 delete orrelng.com 2>/dev/null || true
#             pm2 start npm --name 'orrelng.com' -- start -- -p 8006
            
#             echo 'âœ… Deployment complete!'
#             exit 0
#           "

# name: Deploy to orrelng.com

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     timeout-minutes: 30

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy to VPS
#         run: |
#           ssh -p 22222 -o ConnectTimeout=300 gsas-admin@${{ secrets.VPS_IP }} "
#             set -e
            
#             echo 'ðŸš€ ========== STARTING DEPLOYMENT =========='
            
#             # Setup directory
#             DEPLOY_DIR=\"/var/www/orrelng.com\"
#             sudo mkdir -p \"\$DEPLOY_DIR\"
#             sudo chown -R gsas-admin:gsas-admin \"\$DEPLOY_DIR\"
            
#             cd \"\$DEPLOY_DIR\"
#             echo 'ðŸ“‚ Directory: \$(pwd)'
            
#             # Clean any existing build
#             # echo 'ðŸ§¹ Cleaning previous build...'
#             # rm -rf .next node_modules package-lock.json 2>/dev/null || true
            
#             # Clone or update
#             if [ -d .git ]; then
#               echo 'â¬‡ï¸ Pulling latest code...'
#               git pull origin main
#             else
#               echo 'ðŸ“¥ Cloning repository...'
#               git clone https://github.com/${{ github.repository }}.git .
#             fi
            
#             # Install dependencies
#             echo 'ðŸ“¦ Installing dependencies...'
#             npm ci
            
#             # # Create environment file (port 8006 as shown in your logs)
#             # echo 'ðŸ”§ Creating .env.local...'
#             # # cat > .env.local << 'EOF'
#             # PORT=8006
#             # NODE_ENV=production
#             # OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
#             # EOF

#             echo 'PORT=8006' > .env.local
#             echo 'NODE_ENV=production' >> .env.local
#             echo 'OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}' >> .env.local
            
#             # Build with timeout
#             timeout 300 npm run build || {
#               echo 'Build took too long, continuing anyway...'
#             }
            
#             # echo 'ðŸ“„ Environment file created:'
#             # cat .env.local | grep -v OPENAI_API_KEY
            
#             # # Build the application
#             # echo 'ðŸ—ï¸ Building Next.js application...'
#             # npm run build
            
#             # Verify build exists
#             echo 'ðŸ” Verifying build...'
#             if [ -d .next ]; then
#               echo 'âœ… Build directory found:'
#               ls -la .next/
#             else
#               echo 'âŒ ERROR: No .next directory after build!'
#               exit 1
#             fi
            
#             # Start with PM2
#             echo 'ðŸ”„ Starting with PM2...'
#             pm2 delete orrel-app 2>/dev/null || true
#             pm2 start npm --name \"orrel-app\" -- start -- -p 8006
            
#             # Save PM2 config
#             pm2 save
            
#             echo 'âœ… ========== DEPLOYMENT COMPLETE =========='
#             echo 'ðŸŒ App should be running on port 8006'
#           "

# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Setup Node.js
#       uses: actions/setup-node@v3
#       with:
#         node-version: '18'
#         cache: 'npm'

#     # - name: Install dependencies
#     #   run: npm ci

#     # - name: Build application
#     #   run: npm run build

#     - name: Deploy to VPS
#       uses: appleboy/ssh-action@v0.1.6
#       with:
#         host: ${{ secrets.VPS_IP }}
#         username: ${{ secrets.VPS_USER }}
#         port: 22222
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script: |
#           # Export OpenAI API key as environment variable
#           export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
          
#           # Go to deployment directory
#           cd /var/www/orrelng.com
          
#           # Make sure deploy.sh is executable
#           chmod +x deploy.sh
          
#           # Run deployment script
#           ./deploy.sh
          
#           echo "ðŸŒ Deployment complete! App running on port 8006"


# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Setup Node.js
#       uses: actions/setup-node@v3
#       with:
#         node-version: '18'
#         cache: 'npm'

#     - name: Set up SSH with custom port
#       uses: webfactory/ssh-agent@v0.7.0
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#     - name: Add VPS to known_hosts with port 22222
#       run: |
#         mkdir -p ~/.ssh
#         chmod 700 ~/.ssh
#         # Add with custom port syntax
#         ssh-keyscan -p 22222 -H ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts
#         chmod 600 ~/.ssh/known_hosts

#     - name: Deploy to VPS via SSH
#       run: |
#         echo "ðŸš€ Deploying via SSH port 22222..."
        
#         # Deploy using SSH with custom port
#         ssh -p 22222 -o ConnectTimeout=30 -o ServerAliveInterval=60 \
#           ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           echo 'ðŸ“ Changing to app directory...'
#           cd /var/www/orrel-app
          
#           echo 'ðŸ“¥ Pulling latest code...'
#           git fetch origin
#           git reset --hard origin/main
#           git clean -fd
          
#           # echo 'ðŸ“¦ Installing dependencies...'
#           # npm ci --omit=dev
          
#           # echo 'ðŸ—ï¸ Building application...'
#           # npm run build
          
#           echo 'ðŸ”„ Restarting PM2...'
#           cd /var/www/orrel-app && ./deploy.sh
#           # pm2 delete orrel-app 2>/dev/null || true
#           # pm2 start ecosystem.config.js
#           # pm2 save
          
#           echo 'âœ… Deployment completed on VPS!'
#         "
        
#         echo "ðŸŽ‰ GitHub Actions deployment completed!"


#         # Clean up any corrupted node_modules
# if [ -d "node_modules" ]; then
#     echo "ðŸ§¹ Cleaning node_modules..."
#     rm -rf node_modules
# fi

# # Clean npm cache
# echo "ðŸ§¹ Cleaning npm cache..."
# npm cache clean --force

# name: Deploy Next.js Frontend

# on:
#   push:
#     branches: [main]
#     # paths:
#     #   - 'orrel-app/**'  # Only deploy when frontend changes

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     # environment: production
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3
#       with:
#         fetch-depth: 0

#     - name: Setup Node.js
#       uses: actions/setup-node@v3
#       with:
#         node-version: '20'  # Match your server's Node version
#         cache: 'npm'
#         # cache-dependency-path: 'orrel-app/package-lock.json'

#     - name: Build and test locally (optional)
#       run: |
#         cd orrel-app
#         echo "ðŸ”§ Installing dependencies..."
#         npm ci --omit=dev
#         echo "ðŸ—ï¸ Building application..."
#         npm run build
#         echo "âœ… Build successful!"
#       if: false  # Set to true if you want to test build before deploy

#     - name: Set up SSH
#       uses: webfactory/ssh-agent@v0.7.0
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#     - name: Add VPS to known_hosts
#       run: |
#         # mkdir -p ~/.ssh
#         # chmod 700 ~/.ssh
#         ssh-keyscan -p 22222 -H ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts
#         # chmod 600 ~/.ssh/known_hosts

#     - name: Deploy to VPS
#       run: |
#         echo "ðŸš€ Deploying to production..."
        
#         # Execute deployment on server
#         ssh -p 22222 \
#           -o ConnectTimeout=30 \
#           -o ServerAliveInterval=60 \
#           -o StrictHostKeyChecking=no \
#           ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} << 'EOF'
#         set -e
        
#         echo "ðŸ”’ Starting secure deployment..."
        
#         # ============================================
#         # CONFIGURATION
#         # ============================================
#         APP_NAME="orrel-app"
#         APP_DIR="/var/www/orrel-app"
#         BACKUP_DIR="/home/admin-gsas/backups"
#         TIMESTAMP=$(date +%Y%m%d_%H%M%S)
#         # ============================================
        
#         # 1. Ensure Node.js is available (already verified)
#         echo "ðŸ“Š Node.js: $(node --version)"
#         echo "ðŸ“Š npm: $(npm --version)"
        
#         # 2. Create backup directory
#         mkdir -p "$BACKUP_DIR"
        
#         # 3. Navigate to app directory
#         cd "$APP_DIR"
#         echo "ðŸ“ Working in: $(pwd)"
        
#         # 4. Backup current version
#         echo "ðŸ“¦ Creating backup..."
#         if [ -d ".next" ] || [ -d "node_modules" ]; then
#           tar czf "$BACKUP_DIR/${APP_NAME}_backup_$TIMESTAMP.tar.gz" \
#             .next \
#             node_modules \
#             package-lock.json \
#             2>/dev/null || echo "Backup created"
#         else
#           echo "First deployment, skipping backup"
#         fi
        
#         # 5. Update code
#         echo "â¬‡ï¸ Pulling latest code..."
#         if [ -d ".git" ]; then
#           git fetch origin
#           git reset --hard origin/main
#           git clean -fd
#           echo "âœ… Code updated"
#         else
#           echo "âŒ Not a git repository"
#           exit 1
#         fi
        
#         # 6. Install dependencies securely
#         echo "ðŸ“¦ Installing dependencies..."
        
#         # Clean previous builds
#         rm -rf .next
        
#         # Check for package-lock.json
#         if [ ! -f "package-lock.json" ]; then
#           echo "âš ï¸ package-lock.json not found. Generating..."
#           npm install --package-lock-only --omit=dev
#         fi
        
#         # Clean install with exact versions
#         npm ci --omit=dev --audit
        
#         echo "âœ… Dependencies installed"
        
#         # 7. Build Next.js application
#         echo "ðŸ—ï¸ Building Next.js application..."
        
#         # Set production environment
#         export NODE_ENV=production
#         export NEXT_TELEMETRY_DISABLED=1
        
#         # Run build
#         if npm run build; then
#           echo "âœ… Build successful"
#           BUILD_SIZE=$(du -sh .next | cut -f1)
#           echo "ðŸ“¦ Build size: $BUILD_SIZE"
#         else
#           echo "âŒ Build failed"
#           exit 1
#         fi
        
#         # 8. Setup PM2
#         echo "âš™ï¸ Configuring PM2..."
        
#         # Check if PM2 is installed
#         if ! command -v pm2 &> /dev/null; then
#           echo "ðŸ“¦ Installing PM2..."
#           npm install -g pm2
#         fi
        
#         # Stop existing process
#         echo "ðŸ”„ Restarting application..."
#         pm2 delete "$APP_NAME" 2>/dev/null || echo "No existing process"
        
#         # Start Next.js
#         # Option A: If using output: 'standalone' in next.config.js
#         if [ -f ".next/standalone/server.js" ]; then
#           echo "ðŸš€ Starting standalone Next.js..."
#           pm2 start .next/standalone/server.js --name "$APP_NAME" \
#             -- \
#             --port 3000 \
#             --hostname 127.0.0.1
#         else
#           # Option B: Regular Next.js start
#           echo "ðŸš€ Starting Next.js on port 3000..."
#           pm2 start npm --name "$APP_NAME" -- \
#             run start -- --port 3000 --hostname 127.0.0.1
#         fi
        
#         # 9. Save PM2 configuration
#         pm2 save
        
#         # 10. Setup PM2 startup (if not already)
#         pm2 startup 2>/dev/null || echo "PM2 startup already configured"
        
#         # 11. Cleanup old backups (keep last 3)
#         echo "ðŸ§¹ Cleaning up old backups..."
#         cd "$BACKUP_DIR"
#         ls -t ${APP_NAME}_backup_*.tar.gz 2>/dev/null | tail -n +4 | xargs -r rm -f || echo "No old backups"
        
#         # 12. Verify deployment
#         echo ""
#         echo "âœ… DEPLOYMENT COMPLETED!"
#         echo "========================="
#         echo "ðŸ“Š Application Status:"
#         pm2 status "$APP_NAME"
#         echo ""
#         echo "ðŸŒ Health check (waiting 5 seconds)..."
#         sleep 5
#         if curl -s -f http://127.0.0.1:3000 > /dev/null; then
#           echo "âœ… Application is healthy on port 3000"
#         else
#           echo "âš ï¸  Warning: Application not responding on port 3000"
#           echo "Checking PM2 logs..."
#           pm2 logs "$APP_NAME" --lines 10 --raw 2>/dev/null || echo "No logs available"
#         fi
        
#         # 13. Final status
#         echo ""
#         echo "ðŸŽ‰ Orrel frontend deployed successfully!"
#         echo "ðŸ”— Access via: https://orrelng.com"
#         EOF
        
#         echo "ðŸŽ‰ GitHub Actions deployment completed!"

# name: ðŸ”’ Secure Deploy Orrel Frontend

# on:
#   push:
#     branches: [main]
#     # paths:
#     #   - '**'  # Monitor all files for changes

# jobs:
#   security-scan:
#     runs-on: ubuntu-latest
#     if: always()
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3
#       with:
#         fetch-depth: 0  # Get full history
        
#     - name: Scan for secrets
#       run: |
#         echo "ðŸ” Scanning for hardcoded secrets..."
#         # Check for API keys, tokens, passwords
#         if find . -type f \( -name "*.js" -o -name "*.ts" -o -name "*.json" -o -name "*.env*" \) \
#           -exec grep -lE "(api[_-]?key|secret[_-]?key|password|token|auth)" {} \; 2>/dev/null | grep -v node_modules | head -5; then
#           echo "âš ï¸  WARNING: Potential secrets found in code!"
#         fi
        
#     - name: Check package vulnerabilities
#       run: |
#         if [ -f "package.json" ]; then
#           echo "ðŸ“¦ Checking npm vulnerabilities..."
#           npm audit --production --audit-level=critical 2>/dev/null || echo "Audit completed"
#         fi

#   deploy:
#     runs-on: ubuntu-latest
#     needs: security-scan
#     if: success() || failure()  # Deploy even if security scan has warnings
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3
#       with:
#         fetch-depth: 0

#     - name: ðŸ” Secure Deploy to VPS
#       uses: appleboy/ssh-action@v0.1.5
#       with:
#         host: ${{ secrets.VPS_IP }}
#         port: 22222
#         username: ${{ secrets.VPS_USER }}
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script_stop: true  # Stop on any error
#         timeout: 900s  # 5 minute timeout
#         script: |
#           set -euo pipefail  # Strict mode: exit on error, undefined vars, pipefail
          
#           echo "ðŸ”’ === SECURE DEPLOYMENT STARTED ==="
#           echo "ðŸ•’ $(date)"
#           echo "ðŸ‘¤ User: $(whoami)"
#           echo "ðŸ” Script running with -euo pipefail (strict mode)"
          
#           # ============================================
#           # CONFIGURATION
#           # ============================================
#           readonly APP_NAME="orrel-app"
#           readonly APP_USER=${{ secrets.VPS_USER }}
#           readonly APP_DIR="/var/www/orrel-app"
#           readonly BACKUP_DIR="/home/$APP_USER/backups"
#           readonly NODE_PATH="/home/$APP_USER/.nvm/versions/node/v24.13.0/bin"
#           readonly TIMESTAMP=$(date +%Y%m%d_%H%M%S)
#           readonly DEPLOY_LOG="/tmp/${APP_NAME}_deploy_${TIMESTAMP}.log"
#           # ============================================
          
#           # Redirect all output to log file for auditing
#           exec > >(tee -a "$DEPLOY_LOG") 2>&1
          
#           # === SECURITY CHECKS ===
#           echo "ðŸ” Running security checks..."
          
#           # 1. Verify running as correct user
#           if [ "$(whoami)" != "$APP_USER" ]; then
#             echo "âŒ SECURITY ERROR: Must run as $APP_USER, not $(whoami)"
#             exit 1
#           fi
          
#           # 2. Ensure Node.js is properly installed
#           if [ ! -f "$NODE_PATH/node" ]; then
#             echo "âŒ Node.js not found at $NODE_PATH/node"
#             exit 1
#           fi
          
#           # 3. Set secure PATH
#           export PATH="$NODE_PATH:$PATH"
#           echo "ðŸ“Š Node.js: $(node --version)"
#           echo "ðŸ“Š npm: $(npm --version)"
          
#           # 4. Create secure backup directory
#           mkdir -p "$BACKUP_DIR"
#           chmod 700 "$BACKUP_DIR"
          
#           # === CHANGE TO APP DIRECTORY ===
#           cd "$APP_DIR" || {
#             echo "âŒ Cannot access $APP_DIR"
#             exit 1
#           }
#           echo "ðŸ“ Working directory: $(pwd)"
          
#           # === BACKUP CURRENT VERSION ===
#           echo "ðŸ“¦ Creating secure backup..."
#           readonly BACKUP_FILE="$BACKUP_DIR/${APP_NAME}_secure_backup_${TIMESTAMP}.tar.gz"
          
#           if [ -d ".git" ] || [ -d "node_modules" ] || [ -d ".next" ]; then
#             # Create encrypted backup (if you have gpg installed)
#             tar czf - . 2>/dev/null | gzip > "$BACKUP_FILE" 2>/dev/null || {
#               echo "âš ï¸  Backup creation failed, continuing anyway..."
#               BACKUP_FILE=""
#             }
            
#             if [ -n "$BACKUP_FILE" ] && [ -f "$BACKUP_FILE" ]; then
#               echo "âœ… Backup created: $(ls -lh "$BACKUP_FILE" | awk '{print $5}')"
#               chmod 600 "$BACKUP_FILE"  # Make backup readable only by owner
#             fi
#           else
#             echo "â„¹ï¸  First deployment or empty directory, skipping backup"
#           fi
          
#           # === VERIFY GIT REPOSITORY ===
#           echo "ðŸ” Verifying git repository..."
#           if [ ! -d ".git" ]; then
#             echo "âŒ Not a git repository. Possible security issue."
#             exit 1
#           fi
          
#           # === UPDATE CODE WITH VERIFICATION ===
#           echo "â¬‡ï¸ Updating code with verification..."
          
#           # Get current commit before update
#           readonly OLD_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "NO_COMMIT")
          
#           # Fetch and update
#           git fetch origin --tags --force 2>&1 | grep -v "pack-objects" || true
#           git reset --hard origin/main
#           git clean -fdx  # Remove all untracked files (security)
          
#           # Get new commit
#           readonly NEW_COMMIT=$(git rev-parse HEAD)
          
#           echo "ðŸ“ Commit changed: $OLD_COMMIT â†’ $NEW_COMMIT"
          
#           # Verify the update actually changed something
#           if [ "$OLD_COMMIT" = "$NEW_COMMIT" ] && [ "$OLD_COMMIT" != "NO_COMMIT" ]; then
#             echo "âš ï¸  No code changes detected"
#           fi
          
#           # === SECURE DEPENDENCY INSTALLATION ===
#           echo "ðŸ“¦ Installing dependencies with security checks..."
          
#           # Clean previous builds and dependencies
#           rm -rf .next node_modules package-lock.json
          
#           # Generate package-lock.json if missing
#           if [ ! -f "package.json" ]; then
#             echo "âŒ package.json not found!"
#             exit 1
#           fi
          
#           if [ ! -f "package-lock.json" ]; then
#             echo "âš ï¸  package-lock.json not found. Generating securely..."
#             npm install --package-lock-only --omit=dev --no-audit --no-fund
#           fi
          
#           # Install with security audit
#           echo "ðŸ” Running npm audit before install..."
#           npm audit --production --audit-level=moderate 2>/dev/null || echo "Audit check completed"
          
#           echo "ðŸ“¦ Installing production dependencies..."
#           npm ci --omit=dev --audit --no-fund
          
#           # === SECURITY SCAN OF NODE_MODULES ===
#           echo "ðŸ” Scanning node_modules for suspicious patterns..."
#           SUSPICIOUS_FILES=$(find node_modules -type f -name "*.js" -exec grep -l "eval(\|child_process\.exec\|spawn\|wget\|curl" {} \; 2>/dev/null | head -10)
          
#           if [ -n "$SUSPICIOUS_FILES" ]; then
#             echo "âš ï¸  WARNING: Suspicious patterns found in node_modules:"
#             echo "$SUSPICIOUS_FILES" | head -5
#             echo "Review these files before continuing deployment."
#             # Uncomment to block deployment:
#             # exit 1
#           fi
          
#           # === BUILD APPLICATION ===
#           echo "ðŸ—ï¸ Building Next.js application..."
          
#           # Set secure environment
#           export NODE_ENV=production
#           export NEXT_TELEMETRY_DISABLED=1
#           export NEXT_PUBLIC_SENTRY_DSN=""  # Clear any analytics
          
#           # Build with production settings
#           if ! npm run build; then
#             echo "âŒ Build failed!"
            
#             # Attempt rollback if backup exists
#             if [ -n "$BACKUP_FILE" ] && [ -f "$BACKUP_FILE" ]; then
#               echo "ðŸ”„ Attempting rollback..."
#               rm -rf .next node_modules
#               tar xzf "$BACKUP_FILE" 2>/dev/null || echo "Rollback failed"
#             fi
            
#             exit 1
#           fi
          
#           BUILD_SIZE=$(du -sh .next | cut -f1)
#           echo "âœ… Build successful: $BUILD_SIZE"
          
#           # === PM2 MANAGEMENT ===
#           echo "âš™ï¸ Configuring PM2..."
          
#           # Install PM2 if not present
#           if ! command -v pm2 &> /dev/null; then
#             echo "ðŸ“¦ Installing PM2 securely..."
#             npm install -g pm2 --no-audit --no-fund
#           fi
          
#           # Stop existing process
#           echo "ðŸ”„ Managing application process..."
#           pm2 delete "$APP_NAME" 2>/dev/null || echo "No existing process found"
          
#           # Start with secure settings
#           echo "ðŸš€ Starting application with secure settings..."
          
#           # Check if standalone build exists (more secure)
#           if [ -f ".next/standalone/server.js" ]; then
#             echo "ðŸ” Using standalone build (more secure)"
#             pm2 start .next/standalone/server.js --name "$APP_NAME" \
#               -- \
#               --port 3000 \
#               --hostname 127.0.0.1 \
#               --no-experimental-https \
#               --no-experimental-fetch
#           else
#             echo "âš¡ Using regular build"
#             pm2 start npm --name "$APP_NAME" -- \
#               run start -- --port 3000 --hostname 127.0.0.1
#           fi
          
#           # Save PM2 configuration
#           pm2 save --force
          
#           # Setup startup if not configured
#           pm2 startup 2>/dev/null | tail -1 | sudo bash 2>/dev/null || echo "PM2 startup already configured"
          
#           # === POST-DEPLOYMENT CHECKS ===
#           echo "ðŸ” Running post-deployment checks..."
          
#           # Wait for app to start
#           sleep 5
          
#           # Check if app is running
#           if ! pm2 ping "$APP_NAME" 2>/dev/null; then
#             echo "âŒ Application failed to start!"
#             pm2 logs "$APP_NAME" --lines 20 --raw 2>/dev/null || true
#             exit 1
#           fi
          
#           # Health check
#           echo "ðŸ¥ Running health check..."
#           if curl -s -f -m 10 http://127.0.0.1:3000 > /dev/null; then
#             echo "âœ… Application is healthy on port 3000"
#           else
#             echo "âš ï¸  Health check failed, but PM2 reports running"
#             pm2 logs "$APP_NAME" --lines 10 --raw 2>/dev/null || true
#           fi
          
#           # === CLEANUP & AUDIT ===
#           echo "ðŸ§¹ Cleaning up..."
          
#           # Remove old backups (keep last 7)
#           cd "$BACKUP_DIR"
#           find . -name "${APP_NAME}_secure_backup_*.tar.gz" -type f -mtime +7 -delete 2>/dev/null || true
          
#           # Count remaining backups
#           BACKUP_COUNT=$(find . -name "${APP_NAME}_secure_backup_*.tar.gz" -type f 2>/dev/null | wc -l)
#           echo "ðŸ“¦ Backups retained: $BACKUP_COUNT"
          
#           # Final security check
#           echo "ðŸ”’ Final security checks..."
#           ps aux | grep "$APP_NAME" | grep -v grep || echo "Process not found in ps"
          
#           # === DEPLOYMENT COMPLETE ===
#           echo ""
#           echo "ðŸŽ‰ === SECURE DEPLOYMENT COMPLETED ==="
#           echo "ðŸ•’ $(date)"
#           echo "ðŸ“± Application: $APP_NAME"
#           echo "ðŸ“ Port: 3000 (internal)"
#           echo "ðŸŒ Access: https://orrelng.com"
#           echo "ðŸ“Š Status:"
#           pm2 status "$APP_NAME" --silent || true
#           echo ""
#           echo "ðŸ“ Deployment log saved to: $DEPLOY_LOG"
#           echo "ðŸ” Backup retained: ${BACKUP_FILE:-None}"
          
#           # Save deployment info for auditing
#           echo "$TIMESTAMP | $NEW_COMMIT | $(whoami) | SUCCESS" >> "$BACKUP_DIR/deployment_audit.log"


# name: ðŸ”’ Secure Deploy Orrel Frontend

# on:
#   push:
#     branches: [main]

# jobs:
#   security-scan:
#     runs-on: ubuntu-latest
#     # timeout-minutes: 10
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4
#       with:
#         fetch-depth: 0
        
#     - name: Setup Node.js
#       uses: actions/setup-node@v4
#       with:
#         node-version: '20.x'
#         cache: 'npm'
        
#     - name: Scan for secrets
#       run: |
#         echo "ðŸ” Scanning for hardcoded secrets..."
#         # Only fail on actual secrets, not warnings
#         exit 0  # Skip for now to focus on deployment

#   deploy:
#     runs-on: ubuntu-latest
#     needs: security-scan
#     timeout-minutes: 30  # Overall timeout
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4
#       with:
#         fetch-depth: 0

#     - name: ðŸ” Secure Deploy to VPS
#       uses: appleboy/ssh-action@v1.2.0
#       with:
#         host: ${{ secrets.VPS_IP }}
#         port: 22222  # Fixed: Use variable
#         username: ${{ secrets.VPS_USER }}
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script_stop: true
#         timeout: 1800  # 30 minutes for build
#         script: |
#           set -euo pipefail
          
#           echo "ðŸ”’ === SECURE DEPLOYMENT STARTED ==="
#           echo "ðŸ•’ $(date)"
#           echo "ðŸ‘¤ User: $(whoami)"
          
#           # ============================================
#           # CONFIGURATION
#           # ============================================
#           APP_NAME="orrel-app"
#           APP_USER="${{ secrets.VPS_USER }}"
#           APP_DIR="/var/www/orrel-app"
#           BACKUP_DIR="/home/$APP_USER/backups"
#           DEPLOY_LOG="/tmp/${APP_NAME}_deploy_$(date +%Y%m%d_%H%M%S).log"
#           # ============================================
          
#           # Redirect output
#           exec > >(tee -a "$DEPLOY_LOG") 2>&1
          
#           # === SECURITY CHECKS ===
#           echo "ðŸ” Running security checks..."
          
#           if [ "$(whoami)" != "$APP_USER" ]; then
#             echo "âŒ Must run as $APP_USER"
#             exit 1
#           fi
          
#           # === CHANGE TO APP DIRECTORY ===
#           cd "$APP_DIR" || {
#             echo "âŒ Cannot access $APP_DIR"
#             exit 1
#           }
#           echo "ðŸ“ Working directory: $(pwd)"
          
#           # === BACKUP CURRENT VERSION ===
#           echo "ðŸ“¦ Creating backup..."
#           BACKUP_FILE="$BACKUP_DIR/${APP_NAME}_backup_$(date +%Y%m%d_%H%M%S).tar.gz"
          
#           if [ -d ".git" ]; then
#             tar --exclude='node_modules' --exclude='.next' -czf "$BACKUP_FILE" . 2>/dev/null || echo "Backup skipped"
#             [ -f "$BACKUP_FILE" ] && chmod 600 "$BACKUP_FILE"
#           fi
          
#           # === UPDATE CODE ===
#           echo "â¬‡ï¸ Updating code..."
#           git fetch origin --tags --force
#           git reset --hard origin/main
#           git clean -fdx
          
#           # === CHECK IF TYPESCRIPT IS NEEDED ===
#           echo "ðŸ” Checking dependencies..."
          
#           # Install ALL dependencies (including dev) for build
#           echo "ðŸ“¦ Installing all dependencies..."
#           npm ci --include=dev --no-audit --no-fund
          
#           # === BUILD WITH TIMEOUT ===
#           echo "ðŸ—ï¸ Building Next.js application (with timeout)..."
          
#           export NODE_ENV=production
#           export NEXT_TELEMETRY_DISABLED=1
          
#           # Set memory limit for build
#           export NODE_OPTIONS="--max-old-space-size=4096"
          
#           # Build with timeout
#           TIMEOUT=600  # 10 minutes for build
          
#           if timeout $TIMEOUT npm run build; then
#             BUILD_SIZE=$(du -sh .next 2>/dev/null | cut -f1 || echo "unknown")
#             echo "âœ… Build successful: $BUILD_SIZE"
#           else
#             echo "âŒ Build timed out or failed after ${TIMEOUT}s"
            
#             # Check memory
#             echo "ðŸ“Š System memory:"
#             free -h || true
            
#             # Attempt rollback
#             if [ -f "$BACKUP_FILE" ]; then
#               echo "ðŸ”„ Rolling back..."
#               rm -rf .next node_modules
#               tar xzf "$BACKUP_FILE" 2>/dev/null || echo "Rollback failed"
#             fi
            
#             exit 1
#           fi
          
#           # === INSTALL PRODUCTION DEPENDENCIES ===
#           echo "ðŸ“¦ Installing production dependencies..."
#           # Remove dev dependencies for production
#           npm ci --omit=dev --no-audit --no-fund
          
#           # === PM2 MANAGEMENT ===
#           echo "âš™ï¸ Configuring PM2..."
          
#           if ! command -v pm2 &> /dev/null; then
#             npm install -g pm2 --no-audit --no-fund
#           fi
          
#           # Stop existing
#           pm2 delete "$APP_NAME" 2>/dev/null || echo "No existing process"
          
#           # Start
#           if [ -f ".next/standalone/server.js" ]; then
#             pm2 start .next/standalone/server.js --name "$APP_NAME" -- --port 3000 --hostname 127.0.0.1
#           else
#             pm2 start npm --name "$APP_NAME" -- start
#           fi
          
#           pm2 save 2>/dev/null || true
          
#           # === HEALTH CHECK ===
#           echo "ðŸ¥ Health check..."
#           sleep 3
          
#           if curl -s -f -m 10 http://127.0.0.1:3000 > /dev/null; then
#             echo "âœ… Application is healthy"
#           else
#             echo "âš ï¸ Health check failed"
#             pm2 logs "$APP_NAME" --lines 10 2>/dev/null || true
#           fi
          
#           # === CLEANUP ===
#           echo "ðŸ§¹ Cleaning old backups..."
#           cd "$BACKUP_DIR"
#           ls -t ${APP_NAME}_backup_*.tar.gz 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true
          
#           # === COMPLETION ===
#           echo ""
#           echo "ðŸŽ‰ === DEPLOYMENT COMPLETED ==="
#           echo "ðŸ•’ $(date)"
#           echo "ðŸ“± App: $APP_NAME"
#           echo "ðŸŒ URL: https://orrelng.com"
#           pm2 status "$APP_NAME" --silent 2>/dev/null || true


# name: ðŸ”’ Secure Deploy Orrel Frontend

# on:
#   push:
#     branches: [main]

# jobs:
#   security-scan:
#     runs-on: ubuntu-latest
#     timeout-minutes: 10
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4
      
#     - name: Quick security check
#       run: |
#         echo "ðŸ” Quick security scan..."
#         # Skip for now to focus on deployment
#         echo "Security scan completed (warnings only)"

#   deploy:
#     runs-on: ubuntu-latest
#     needs: security-scan
#     timeout-minutes: 45
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4
#       with:
#         fetch-depth: 0

#     - name: ðŸ” Test SSH Connection
#       run: |
#         echo "Testing SSH connection..."
#         mkdir -p ~/.ssh
#         echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
#         chmod 600 ~/.ssh/deploy_key
        
#         ssh -i ~/.ssh/deploy_key \
#             -o StrictHostKeyChecking=no \
#             -o ConnectTimeout=10 \
#             -p 22222 \
#             ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} \
#             "echo 'âœ… SSH connection test successful'" || {
#               echo "âŒ SSH connection failed"
#               exit 1
#             }

#     - name: ðŸš€ Deploy to VPS
#       uses: appleboy/ssh-action@v1.2.0
#       with:
#         host: ${{ secrets.VPS_IP }}
#         port: 22222
#         username: ${{ secrets.VPS_USER }}
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script_stop: true
#         timeout: 1800s  # FIXED: Added 's' for seconds
#         script: |
#           set -euo pipefail
          
#           echo "=== DEPLOYMENT STARTED ==="
#           echo "Time: $(date)"
#           echo "User: $(whoami)"
          
#           # Configuration
#           APP_NAME="orrel-app"
#           APP_USER="${{ secrets.VPS_USER }}"
#           APP_DIR="/var/www/orrel-app"
#           BACKUP_DIR="/home/$APP_USER/backups"
          
#           # Security check
#           if [ "$(whoami)" != "$APP_USER" ]; then
#             echo "âŒ Must run as $APP_USER"
#             exit 1
#           fi
          
#           # Go to app directory
#           cd "$APP_DIR" || {
#             echo "âŒ Cannot access $APP_DIR"
#             exit 1
#           }
          
#           echo "ðŸ“ Directory: $(pwd)"
          
#           # Backup (quick)
#           echo "ðŸ“¦ Creating backup..."
#           BACKUP_FILE="$BACKUP_DIR/backup_$(date +%Y%m%d_%H%M%S).tar.gz"
#           mkdir -p "$BACKUP_DIR"
          
#           if [ -d ".git" ]; then
#             tar --exclude='node_modules' --exclude='.next' -czf "$BACKUP_FILE" . 2>/dev/null || echo "Backup skipped"
#           fi
          
#           # Update code
#           echo "â¬‡ï¸ Updating code..."
#           git fetch origin main --force
#           git reset --hard origin/main
#           git clean -fd
          
#           # Install dependencies (including dev for build)
#           echo "ðŸ“¦ Installing dependencies..."
          
#           # Clean previous install
#           rm -rf node_modules .next package-lock.json
          
#           # Install ALL dependencies for build
#           npm ci --include=dev --no-audit --no-fund
          
#           # Build with timeout
#           echo "ðŸ—ï¸ Building application..."
#           export NODE_ENV=production
#           export NEXT_TELEMETRY_DISABLED=1
#           export NODE_OPTIONS="--max-old-space-size=4096"
          
#           # Build with 10 minute timeout
#           if timeout 600 npm run build; then
#             echo "âœ… Build successful"
#           else
#             echo "âŒ Build failed or timed out"
            
#             # Rollback if backup exists
#             if [ -f "$BACKUP_FILE" ]; then
#               echo "ðŸ”„ Rolling back..."
#               rm -rf .next node_modules
#               tar xzf "$BACKUP_FILE" 2>/dev/null || true
#             fi
            
#             exit 1
#           fi
          
#           # Install production-only dependencies
#           echo "âš¡ Installing production dependencies..."
#           npm ci --omit=dev --no-audit --no-fund
          
#           # PM2 setup
#           echo "âš™ï¸ Setting up PM2..."
          
#           if ! command -v pm2 &> /dev/null; then
#             npm install -g pm2 --no-audit --no-fund
#           fi
          
#           # Restart application
#           pm2 delete "$APP_NAME" 2>/dev/null || echo "No existing process"
          
#           if [ -f ".next/standalone/server.js" ]; then
#             pm2 start .next/standalone/server.js --name "$APP_NAME" -- --port 3000 --hostname 127.0.0.1
#           else
#             pm2 start npm --name "$APP_NAME" -- start
#           fi
          
#           pm2 save 2>/dev/null || true
          
#           # Health check
#           echo "ðŸ¥ Checking application..."
#           sleep 5
          
#           if curl -s -f -m 10 http://127.0.0.1:3000 > /dev/null; then
#             echo "âœ… Application is running"
#           else
#             echo "âš ï¸ Health check failed"
#             pm2 logs "$APP_NAME" --lines 10 2>/dev/null || true
#           fi
          
#           # Cleanup old backups
#           echo "ðŸ§¹ Cleaning up..."
#           cd "$BACKUP_DIR"
#           ls -t backup_*.tar.gz 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true
          
#           echo ""
#           echo "ðŸŽ‰ === DEPLOYMENT COMPLETED ==="
#           echo "Time: $(date)"
#           echo "App: $APP_NAME"
#           echo "URL: https://orrelng.com"


# name: ðŸ”’ Secure Deploy Orrel Frontend

# on:
#   push:
#     branches: [main]

# jobs:
#   security-scan:
#     runs-on: ubuntu-latest
#     timeout-minutes: 5
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4
      
#     - name: Quick security check
#       run: |
#         echo "ðŸ” Security scan (non-blocking)..."
#         # Skip blocking checks for now
#         echo "âœ… Security checks passed"

#   deploy:
#     runs-on: ubuntu-latest
#     needs: security-scan
#     timeout-minutes: 30
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4

#     - name: ðŸ” Deploy to VPS
#       uses: appleboy/ssh-action@v1.2.0
#       with:
#         host: ${{ secrets.VPS_IP }}
#         port: 22222
#         username: ${{ secrets.VPS_USER }}
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script_stop: true
#         timeout: 1800s
#         script: |
#           set -euo pipefail
          
#           echo "=== DEPLOYMENT STARTED ==="
#           echo "Time: $(date)"
#           echo "User: $(whoami)"
          
#           # Configuration
#           APP_NAME="orrel-app"
#           APP_DIR="/var/www/orrel-app"
#           BACKUP_DIR="/home/${{ secrets.VPS_USER }}/backups"
          
#           # === CHECK AND INSTALL NODE.JS ===
#           echo "ðŸ” Checking Node.js installation..."
          
#           # Method 1: Check for nvm
#           if [ -s "$HOME/.nvm/nvm.sh" ]; then
#             echo "ðŸ“¦ Using nvm..."
#             source "$HOME/.nvm/nvm.sh"
#             nvm use 20 || nvm install 20
#           # Method 2: Check for existing Node.js
#           elif command -v node &> /dev/null; then
#             echo "âœ… Node.js already installed"
#           # Method 3: Install Node.js using nodesource
#           else
#             echo "ðŸ“¦ Installing Node.js 20..."
#             curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
#             sudo apt-get install -y nodejs
#           fi
          
#           # Verify installation
#           NODE_VERSION=$(node --version 2>/dev/null || echo "NOT_FOUND")
#           NPM_VERSION=$(npm --version 2>/dev/null || echo "NOT_FOUND")
          
#           echo "ðŸ“Š Node.js: $NODE_VERSION"
#           echo "ðŸ“Š npm: $NPM_VERSION"
          
#           if [ "$NODE_VERSION" = "NOT_FOUND" ] || [ "$NPM_VERSION" = "NOT_FOUND" ]; then
#             echo "âŒ Node.js/npm not found after installation attempt"
#             echo "Trying alternative installation..."
            
#             # Alternative: Install from tarball
#             cd /tmp
#             curl -O https://nodejs.org/dist/v20.18.0/node-v20.18.0-linux-x64.tar.xz
#             tar -xf node-v20.18.0-linux-x64.tar.xz
#             sudo mv node-v20.18.0-linux-x64 /opt/node
#             sudo ln -sf /opt/node/bin/node /usr/local/bin/node
#             sudo ln -sf /opt/node/bin/npm /usr/local/bin/npm
#             sudo ln -sf /opt/node/bin/npx /usr/local/bin/npx
            
#             # Cleanup
#             rm -f node-v20.18.0-linux-x64.tar.xz
            
#             # Verify again
#             node --version && npm --version || {
#               echo "âŒ Failed to install Node.js"
#               exit 1
#             }
#           fi
          
#           # Set PATH to include node binaries
#           export PATH="$PATH:/usr/local/bin:/usr/bin:/opt/node/bin:$HOME/.nvm/versions/node/*/bin"
          
#           # === GO TO APP DIRECTORY ===
#           echo "ðŸ“ Changing to app directory..."
#           cd "$APP_DIR" || {
#             echo "âŒ Cannot access $APP_DIR"
#             echo "Creating directory..."
#             sudo mkdir -p "$APP_DIR"
#             sudo chown -R $USER:$USER "$APP_DIR"
#             cd "$APP_DIR"
#           }
          
#           echo "ðŸ“ Current directory: $(pwd)"
#           echo "ðŸ“ Contents:"
#           ls -la
          
#           # === BACKUP ===
#           echo "ðŸ“¦ Creating backup..."
#           mkdir -p "$BACKUP_DIR"
#           BACKUP_FILE="$BACKUP_DIR/backup_$(date +%Y%m%d_%H%M%S).tar.gz"
          
#           if [ -d ".git" ] || [ -f "package.json" ]; then
#             tar --exclude='node_modules' --exclude='.next' -czf "$BACKUP_FILE" . 2>/dev/null || echo "Backup skipped"
#             echo "âœ… Backup created: $BACKUP_FILE"
#           else
#             echo "â„¹ï¸ First deployment or empty directory"
#           fi
          
#           # === UPDATE CODE ===
#           echo "â¬‡ï¸ Updating code..."
          
#           # Check if git repo exists
#           if [ ! -d ".git" ]; then
#             echo "ðŸ“¦ Cloning repository..."
#             git clone https://github.com/GSASConnect-Global-Ltd/osmium-latest.git .
#           else
#             echo "ðŸ”„ Pulling latest changes..."
#             git fetch origin --tags --force
#             git reset --hard origin/main
#             git clean -fd
#           fi
          
#           # === INSTALL DEPENDENCIES ===
#           echo "ðŸ“¦ Installing dependencies..."
          
#           # Clean previous installations
#           rm -rf node_modules .next package-lock.json
          
#           # Check if package.json exists
#           if [ ! -f "package.json" ]; then
#             echo "âŒ package.json not found!"
#             echo "ðŸ“ Current files:"
#             ls -la
#             exit 1
#           fi
          
#           echo "ðŸ“„ package.json content:"
#           cat package.json | head -20
          
#           # Install ALL dependencies (including dev for build)
#           echo "ðŸ”§ Installing all dependencies..."
#           npm ci --include=dev --no-audit --no-fund --ignore-scripts || {
#             echo "âš ï¸ npm ci failed, trying npm install..."
#             npm install --include=dev --no-audit --no-fund
#           }
          
#           # === BUILD APPLICATION ===
#           echo "ðŸ—ï¸ Building application..."
          
#           export NODE_ENV=production
#           export NEXT_TELEMETRY_DISABLED=1
#           export NODE_OPTIONS="--max-old-space-size=4096"
          
#           # Check if build script exists
#           if grep -q '"build"' package.json; then
#             echo "ðŸ”¨ Running build..."
#             if timeout 600 npm run build; then
#               echo "âœ… Build successful"
              
#               # Check build output
#               if [ -d ".next" ]; then
#                 BUILD_SIZE=$(du -sh .next | cut -f1)
#                 echo "ðŸ“¦ Build size: $BUILD_SIZE"
#               else
#                 echo "âš ï¸ .next directory not found after build"
#               fi
#             else
#               echo "âŒ Build failed or timed out"
              
#               # Rollback if backup exists
#               if [ -f "$BACKUP_FILE" ]; then
#                 echo "ðŸ”„ Rolling back..."
#                 rm -rf .next node_modules
#                 tar xzf "$BACKUP_FILE" 2>/dev/null || echo "Rollback failed"
#               fi
              
#               exit 1
#             fi
#           else
#             echo "ðŸ“­ No build script found in package.json"
#           fi
          
#           # === INSTALL PRODUCTION DEPENDENCIES ===
#           echo "âš¡ Installing production dependencies..."
#           npm ci --omit=dev --no-audit --no-fund --ignore-scripts || {
#             echo "âš ï¸ Production install failed, using existing node_modules"
#           }
          
#           # === PM2 SETUP ===
#           echo "âš™ï¸ Setting up PM2..."
          
#           # Install PM2 globally if not present
#           if ! command -v pm2 &> /dev/null; then
#             echo "ðŸ“¦ Installing PM2..."
#             npm install -g pm2 --no-audit --no-fund
#           fi
          
#           # Stop existing process
#           pm2 delete "$APP_NAME" 2>/dev/null || echo "No existing process found"
          
#           # Start application
#           echo "ðŸš€ Starting application..."
          
#           if [ -f ".next/standalone/server.js" ]; then
#             echo "ðŸ” Using standalone mode"
#             pm2 start .next/standalone/server.js \
#               --name "$APP_NAME" \
#               --log "/var/log/$APP_NAME.log" \
#               --time \
#               -- \
#               --port=3000 \
#               --hostname=127.0.0.1
#           elif [ -f "package.json" ] && grep -q '"start"' package.json; then
#             echo "âš¡ Using npm start"
#             pm2 start npm \
#               --name "$APP_NAME" \
#               --log "/var/log/$APP_NAME.log" \
#               --time \
#               -- \
#               start
#           else
#             echo "âŒ No start method found"
#             exit 1
#           fi
          
#           # Save PM2 configuration
#           pm2 save 2>/dev/null || true
          
#           # Setup PM2 startup
#           echo "ðŸ”§ Setting up PM2 startup..."
#           pm2 startup 2>/dev/null | tail -1 | sudo bash 2>/dev/null || echo "PM2 startup already configured"
          
#           # === HEALTH CHECK ===
#           echo "ðŸ¥ Running health check..."
#           sleep 5
          
#           MAX_RETRIES=5
#           for i in $(seq 1 $MAX_RETRIES); do
#             if curl -s -f -m 5 http://127.0.0.1:3000 > /dev/null; then
#               echo "âœ… Application is healthy (attempt $i/$MAX_RETRIES)"
#               break
#             fi
            
#             if [ $i -eq $MAX_RETRIES ]; then
#               echo "âš ï¸ Health check failed after $MAX_RETRIES attempts"
#               echo "ðŸ“‹ PM2 logs:"
#               pm2 logs "$APP_NAME" --lines 10 2>/dev/null || echo "No logs available"
#             else
#               echo "  Waiting... (attempt $i/$MAX_RETRIES)"
#               sleep 3
#             fi
#           done
          
#           # === CLEANUP ===
#           echo "ðŸ§¹ Cleaning up old backups..."
#           cd "$BACKUP_DIR"
#           ls -t backup_*.tar.gz 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true
          
#           # === DEPLOYMENT COMPLETE ===
#           echo ""
#           echo "ðŸŽ‰ === DEPLOYMENT COMPLETED SUCCESSFULLY ==="
#           echo "ðŸ•’ Time: $(date)"
#           echo "ðŸ“± Application: $APP_NAME"
#           echo "ðŸŒ URL: https://orrelng.com"
#           echo "ðŸ“Š Node.js: $(node --version)"
#           echo "ðŸ“Š npm: $(npm --version)"
#           echo ""
#           echo "ðŸ“‹ PM2 Status:"
#           pm2 status "$APP_NAME" --silent 2>/dev/null || echo "Status check failed"
          
#           # Log deployment
#           echo "$(date) | SUCCESS | $(git rev-parse --short HEAD 2>/dev/null || echo "unknown")" >> "$BACKUP_DIR/deployments.log"

# name: ðŸš€ Simple Deploy Orrel Frontend

# on:
#   push:
#     branches: [main]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     timeout-minutes: 10
    
#     steps:
#     - name: ðŸ“¥ Checkout code
#       uses: actions/checkout@v4

#     - name: ðŸš€ Deploy to VPS
#       uses: appleboy/ssh-action@v1.2.0
#       with:
#         host: ${{ secrets.VPS_IP }}
#         port: 22222
#         username: ${{ secrets.VPS_USER }}
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         timeout: 300s  # 5 minutes
#         script: |
#           echo "ðŸš€ Starting simple deployment..."
          
#           # App configuration
#           APP_NAME="orrel-app"
#           APP_DIR="/var/www/orrel-app"
          
#           # 1. Install Node.js if not present
#           if ! command -v node &> /dev/null; then
#             echo "ðŸ“¦ Installing Node.js..."
#             curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
#             sudo apt-get install -y nodejs
#           fi
          
#           echo "âœ… Node.js: $(node --version)"
#           echo "âœ… npm: $(npm --version)"
          
#           # 2. Go to app directory
#           echo "ðŸ“ Going to app directory: $APP_DIR"
#           cd "$APP_DIR" || {
#             echo "âŒ Could not access $APP_DIR"
#             echo "Creating directory..."
#             sudo mkdir -p "$APP_DIR"
#             sudo chown -R $USER:$USER "$APP_DIR"
#             cd "$APP_DIR"
#           }
          
#           # 3. Update code
#           echo "â¬‡ï¸ Updating code..."
#           if [ -d ".git" ]; then
#             git pull origin main
#           else
#             echo "ðŸ“¦ Cloning fresh..."
#             git clone https://github.com/GSASConnect-Global-Ltd/osmium-latest.git .
#           fi
          
#           # 4. Install dependencies
#           echo "ðŸ“¦ Installing dependencies..."
#           npm install
          
#           # 5. Build
#           echo "ðŸ—ï¸ Building..."
#           npm run build
          
#           # 6. Install PM2 if needed
#           if ! command -v pm2 &> /dev/null; then
#             echo "ðŸ“¦ Installing PM2..."
#             npm install -g pm2
#           fi
          
#           # 7. Start/Restart app
#           echo "ðŸš€ Starting application..."
#           pm2 delete "$APP_NAME" 2>/dev/null || true
#           pm2 start npm --name "$APP_NAME" -- start
          
#           # 8. Save PM2 config
#           pm2 save 2>/dev/null || true
          
#           echo ""
#           echo "ðŸŽ‰ DEPLOYMENT COMPLETED!"
#           echo "ðŸ“± App: $APP_NAME"
#           echo "ðŸŒ URL: https://orrelng.com"
#           echo "ðŸ•’ Time: $(date)"


name: ðŸš€ Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸš€ Deploy to Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.VPS_IP }}
          port: 22222
          username: admin-gsas
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # Exit on any error
            
            echo "ðŸš€ Starting deployment..."
            
            # ================================================================
            # 1. SETUP PATH FOR NODE.JS
            # ================================================================
            echo "ðŸ“Š Setting up Node.js PATH..."
            
            # Primary nvm path
            NVM_PATH="/home/admin-gsas/.nvm/versions/node/v24.13.0/bin"
            
            if [ -d "$NVM_PATH" ]; then
              echo "âœ… Found Node.js at: $NVM_PATH"
              export PATH="$NVM_PATH:$PATH"
              
              # Create symlinks
              sudo ln -sf "$NVM_PATH/node" /usr/local/bin/node 2>/dev/null || true
              sudo ln -sf "$NVM_PATH/npm" /usr/local/bin/npm 2>/dev/null || true
              sudo ln -sf "$NVM_PATH/npx" /usr/local/bin/npx 2>/dev/null || true
            else
              echo "ðŸ” Searching for Node.js..."
              # Try common locations
              for path in "/usr/local/bin" "/usr/bin" "/opt/node/bin" "/home/admin-gsas/.nvm/versions/node/*/bin"; do
                if [ -f "$path/npm" ]; then
                  echo "âœ… Found npm at: $path"
                  export PATH="$path:$PATH"
                  break
                fi
              done
            fi
            
            # Verify
            echo "ðŸ“Š Node.js: $(node --version 2>/dev/null || echo 'Not found')"
            echo "ðŸ“Š npm: $(npm --version 2>/dev/null || echo 'Not found')"
            
            if ! command -v npm &> /dev/null; then
              echo "âŒ npm not found! Installing..."
              curl -fsSL https://deb.nodesource.com/setup_24.x | sudo -E bash -
              sudo apt install -y nodejs
            fi
            
            # ================================================================
            # 2. CONFIGURATION
            # ================================================================
            APP_NAME="orrel-app"
            APP_DIR="/var/www/orrel-app"
            BACKUP_DIR="/home/admin-gsas/backups"
            
            echo "ðŸ“± Application: $APP_NAME"
            echo "ðŸ“ Directory: $APP_DIR"
            
            # Create backup directory
            mkdir -p "$BACKUP_DIR"
            
            # ================================================================
            # 3. GO TO APP DIRECTORY
            # ================================================================
            echo "ðŸ“ Changing to app directory..."
            if [ ! -d "$APP_DIR" ]; then
              echo "ðŸ“¦ Creating app directory..."
              sudo mkdir -p "$APP_DIR"
              sudo chown -R admin-gsas:admin-gsas "$APP_DIR"
            fi
            
            cd "$APP_DIR" || {
              echo "âŒ Failed to access $APP_DIR"
              exit 1
            }
            
            echo "âœ… Current directory: $(pwd)"
            
            # ================================================================
            # 4. CREATE BACKUP
            # ================================================================
            echo "ðŸ“¦ Creating backup..."
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="$BACKUP_DIR/${APP_NAME}_backup_$TIMESTAMP.tar.gz"
            
            if [ -d ".git" ] || [ -f "package.json" ]; then
              tar --exclude='node_modules' --exclude='.next' -czf "$BACKUP_FILE" . 2>/dev/null && \
                echo "âœ… Backup created: $BACKUP_FILE" || \
                echo "âš ï¸ Backup creation had issues"
            else
              echo "â„¹ï¸ First deployment - no backup needed"
            fi
            
            # ================================================================
            # 5. UPDATE CODE
            # ================================================================
            echo "â¬‡ï¸ Updating code..."
            
            if [ -d ".git" ]; then
              git fetch origin
              git reset --hard origin/main
              git clean -fd
              echo "âœ… Code updated"
            else
              echo "ðŸ“¦ Cloning repository..."
              git clone https://github.com/GSASConnect-Global-Ltd/osmium-latest.git .
            fi
            
            # ================================================================
            # 6. INSTALL DEPENDENCIES
            # ================================================================
            echo "ðŸ“¦ Installing dependencies..."
            
            # Clean previous
            rm -rf node_modules .next package-lock.json
            
            # Install all dependencies (including dev for build)
            npm ci --include=dev --no-audit --no-fund || {
              echo "âš ï¸ npm ci failed, trying npm install..."
              npm install --include=dev --no-audit --no-fund
            }
            
            # ================================================================
            # 7. BUILD APPLICATION
            # ================================================================
            echo "ðŸ—ï¸ Building application..."
            
            export NODE_ENV=production
            export NEXT_TELEMETRY_DISABLED=1
            
            if npm run build; then
              echo "âœ… Build successful"
              
              # Check build output
              if [ -d ".next" ]; then
                BUILD_SIZE=$(du -sh .next | cut -f1)
                echo "ðŸ“¦ Build size: $BUILD_SIZE"
              fi
            else
              echo "âŒ Build failed!"
              
              # Rollback
              if [ -f "$BACKUP_FILE" ]; then
                echo "ðŸ”„ Rolling back from backup..."
                rm -rf .next node_modules
                tar -xzf "$BACKUP_FILE" 2>/dev/null || echo "Rollback failed"
              fi
              
              exit 1
            fi
            
            # Install production-only dependencies
            echo "âš¡ Installing production dependencies..."
            npm ci --omit=dev --no-audit --no-fund || {
              echo "âš ï¸ Production install failed, continuing..."
            }
            
            # ================================================================
            # 8. PM2 SETUP
            # ================================================================
            echo "âš™ï¸ Setting up PM2..."
            
            # Install PM2 if not present
            if ! command -v pm2 &> /dev/null; then
              echo "ðŸ“¦ Installing PM2..."
              npm install -g pm2 --no-audit --no-fund
            fi
            
            # Restart application
            echo "ðŸ”„ Restarting application..."
            
            # Stop existing process
            pm2 delete "$APP_NAME" 2>/dev/null || echo "No existing process found"
            
            # Start new process
            if [ -f ".next/standalone/server.js" ]; then
              echo "ðŸ” Using standalone build"
              pm2 start .next/standalone/server.js --name "$APP_NAME" -- --port 3000 --hostname 127.0.0.1
            else
              echo "âš¡ Using npm start"
              pm2 start npm --name "$APP_NAME" -- run start
            fi
            
            # Save PM2 config
            pm2 save 2>/dev/null || echo "PM2 save failed"
            
            # Setup startup
            echo "ðŸ”§ Setting up PM2 startup..."
            pm2 startup 2>/dev/null | tail -1 | sudo bash 2>/dev/null || echo "PM2 startup already configured"
            
            # ================================================================
            # 9. HEALTH CHECK
            # ================================================================
            echo "ðŸ¥ Running health check..."
            sleep 5  # Give app time to start
            
            MAX_RETRIES=3
            HEALTHY=false
            
            for i in $(seq 1 $MAX_RETRIES); do
              if curl -s -f -m 5 http://127.0.0.1:3000 > /dev/null; then
                echo "âœ… Application is healthy (attempt $i/$MAX_RETRIES)"
                HEALTHY=true
                break
              else
                echo "  Waiting... (attempt $i/$MAX_RETRIES)"
                sleep 3
              fi
            done
            
            if [ "$HEALTHY" = false ]; then
              echo "âš ï¸ Health check failed after $MAX_RETRIES attempts"
              echo "ðŸ“‹ Checking PM2 logs..."
              pm2 logs "$APP_NAME" --lines 10 2>/dev/null || echo "No logs available"
            fi
            
            # ================================================================
            # 10. CLEANUP
            # ================================================================
            echo "ðŸ§¹ Cleaning up old backups..."
            cd "$BACKUP_DIR"
            
            # Keep last 5 backups
            ls -t ${APP_NAME}_backup_*.tar.gz 2>/dev/null | tail -n +6 | while read -r file; do
              echo "  Removing: $file"
              rm -f "$file" 2>/dev/null || true
            done
            
            BACKUP_COUNT=$(ls -1 ${APP_NAME}_backup_*.tar.gz 2>/dev/null | wc -l)
            echo "ðŸ“¦ Backups retained: $BACKUP_COUNT"
            
            # ================================================================
            # 11. FINAL STATUS
            # ================================================================
            echo ""
            echo "ðŸŽ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
            echo "========================================"
            echo "ðŸ“± Application: $APP_NAME"
            echo "ðŸ“ Directory: $APP_DIR"
            echo "ðŸŒ URL: https://orrelng.com"
            echo "ðŸ•’ Time: $(date)"
            echo "ðŸ“Š Node.js: $(node --version)"
            echo "ðŸ“Š npm: $(npm --version)"
            echo ""
            echo "ðŸ“‹ PM2 Status:"
            pm2 status "$APP_NAME" --silent 2>/dev/null || {
              echo "  Could not get PM2 status"
              echo "  Checking process directly..."
              ps aux | grep -v grep | grep "$APP_NAME" || echo "  No process found"
            }
            
            echo ""
            echo "âœ… Deployment complete! The application should now be live."


# name: ðŸš€ Deploy to VPS

# on:
#   push:
#     branches: [main]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     timeout-minutes: 60  # 1 hour overall timeout
    
#     steps:
#       - name: ðŸ“¥ Checkout code
#         uses: actions/checkout@v4
      
#       - name: ðŸš€ Deploy to Server
#         uses: appleboy/ssh-action@v1.2.0  # Updated to v1.2.0
#         with:
#           host: ${{ secrets.VPS_IP }}
#           port: 22222
#           username: ${{ secrets.VPS_USER || 'admin-gsas' }}
#           key: ${{ secrets.SSH_PRIVATE_KEY }}
#           script_stop: true
#           timeout: 3600s  # 1 HOUR timeout for SSH action
#           envs: '["NODE_OPTIONS"]'
#         env:
#           NODE_OPTIONS: "--max-old-space-size=8192"  # 8GB memory for build
#           # ================================================================
#           # DEPLOYMENT SCRIPT WITH EXTENDED TIMEOUTS
#           # ================================================================
#           script: |
#             set -euo pipefail  # Strict error handling
            
#             echo "ðŸš€ STARTING DEPLOYMENT WITH 1-HOUR TIMEOUT"
#             echo "â° Start time: $(date)"
#             echo "=========================================="
            
#             # ================================================================
#             # 1. SETUP PATH FOR NODE.JS
#             # ================================================================
#             echo "ðŸ“Š Setting up Node.js PATH..."
            
#             # Primary nvm path
#             NVM_PATH="/home/$(whoami)/.nvm/versions/node/v24.13.0/bin"
            
#             if [ -d "$NVM_PATH" ]; then
#               echo "âœ… Found Node.js at: $NVM_PATH"
#               export PATH="$NVM_PATH:$PATH"
              
#               # Create symlinks
#               sudo ln -sf "$NVM_PATH/node" /usr/local/bin/node 2>/dev/null || true
#               sudo ln -sf "$NVM_PATH/npm" /usr/local/bin/npm 2>/dev/null || true
#               sudo ln -sf "$NVM_PATH/npx" /usr/local/bin/npx 2>/dev/null || true
#             else
#               echo "ðŸ” Searching for Node.js..."
#               # Try common locations
#               for path in "/usr/local/bin" "/usr/bin" "/opt/node/bin" "/home/$(whoami)/.nvm/versions/node/*/bin"; do
#                 for actual_path in $path; do
#                   if [ -f "$actual_path/npm" ]; then
#                     echo "âœ… Found npm at: $actual_path"
#                     export PATH="$actual_path:$PATH"
#                     break 2
#                   fi
#                 done
#               done
#             fi
            
#             # Verify
#             echo "ðŸ“Š Node.js: $(node --version 2>/dev/null || echo 'Checking...')"
#             echo "ðŸ“Š npm: $(npm --version 2>/dev/null || echo 'Checking...')"
            
#             if ! command -v npm &> /dev/null; then
#               echo "âŒ npm not found! Installing Node.js 20..."
#               curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
#               sudo apt install -y nodejs
#             fi
            
#             # ================================================================
#             # 2. CONFIGURATION
#             # ================================================================
#             APP_NAME="orrel-app"
#             APP_DIR="/var/www/orrel-app"
#             BACKUP_DIR="/home/$(whoami)/backups"
            
#             echo ""
#             echo "âš™ï¸ CONFIGURATION:"
#             echo "  App Name: $APP_NAME"
#             echo "  App Dir: $APP_DIR"
#             echo "  Backup Dir: $BACKUP_DIR"
#             echo ""
            
#             # Create backup directory
#             mkdir -p "$BACKUP_DIR"
            
#             # ================================================================
#             # 3. GO TO APP DIRECTORY
#             # ================================================================
#             echo "ðŸ“ Changing to app directory..."
#             if [ ! -d "$APP_DIR" ]; then
#               echo "ðŸ“¦ Creating app directory..."
#               sudo mkdir -p "$APP_DIR"
#               sudo chown -R $(whoami):$(whoami) "$APP_DIR"
#             fi
            
#             cd "$APP_DIR" || {
#               echo "âŒ Failed to access $APP_DIR"
#               exit 1
#             }
            
#             echo "âœ… Current directory: $(pwd)"
#             echo "ðŸ“ Contents:"
#             ls -la
            
#             # ================================================================
#             # 4. CREATE BACKUP (WITH TIMEOUT)
#             # ================================================================
#             echo ""
#             echo "ðŸ“¦ Creating backup..."
#             TIMESTAMP=$(date +%Y%m%d_%H%M%S)
#             BACKUP_FILE="$BACKUP_DIR/${APP_NAME}_backup_$TIMESTAMP.tar.gz"
            
#             if [ -d ".git" ] || [ -f "package.json" ]; then
#               # Backup with 5-minute timeout
#               timeout 300 tar --exclude='node_modules' --exclude='.next' -czf "$BACKUP_FILE" . 2>/dev/null && \
#                 echo "âœ… Backup created: $(du -h "$BACKUP_FILE" | cut -f1)" || \
#                 echo "âš ï¸ Backup creation had issues or timed out"
#             else
#               echo "â„¹ï¸ First deployment - no backup needed"
#             fi
            
#             # ================================================================
#             # 5. UPDATE CODE
#             # ================================================================
#             echo ""
#             echo "â¬‡ï¸ Updating code..."
            
#             if [ -d ".git" ]; then
#               # Git operations with timeout
#               timeout 120 git fetch origin 2>&1 | tail -20
#               timeout 30 git reset --hard origin/main
#               timeout 30 git clean -fd
#               echo "âœ… Code updated"
#             else
#               echo "ðŸ“¦ Cloning repository (15 minute timeout)..."
#               timeout 900 git clone https://github.com/GSASConnect-Global-Ltd/osmium-latest.git .
#             fi
            
#             CURRENT_COMMIT=$(git log --oneline -1 2>/dev/null || echo "No git")
#             echo "ðŸ“ Current commit: $CURRENT_COMMIT"
            
#             # ================================================================
#             # 6. INSTALL DEPENDENCIES (EXTENDED TIMEOUT)
#             # ================================================================
#             echo ""
#             echo "ðŸ“¦ Installing dependencies (15 minute timeout)..."
            
#             # Clean previous
#             rm -rf node_modules .next package-lock.json
            
#             # Set build environment
#             export NODE_ENV=production
#             export NEXT_TELEMETRY_DISABLED=1
#             export NODE_OPTIONS="--max-old-space-size=8192"  # 8GB memory
            
#             # Install with 15-minute timeout
#             echo "â³ Running npm install (this may take several minutes)..."
#             if timeout 900 npm ci --include=dev --no-audit --no-fund --ignore-scripts; then
#               echo "âœ… Dependencies installed successfully"
#             else
#               echo "âš ï¸ npm ci timed out or failed, trying regular npm install..."
#               timeout 1200 npm install --include=dev --no-audit --no-fund || {
#                 echo "âŒ Dependency installation failed"
                
#                 # Rollback
#                 if [ -f "$BACKUP_FILE" ]; then
#                   echo "ðŸ”„ Rolling back from backup..."
#                   rm -rf .next node_modules package-lock.json
#                   timeout 300 tar -xzf "$BACKUP_FILE" 2>/dev/null || echo "Rollback failed"
#                 fi
                
#                 exit 1
#               }
#             fi
            
#             # ================================================================
#             # 7. BUILD APPLICATION (30 MINUTE TIMEOUT)
#             # ================================================================
#             echo ""
#             echo "ðŸ—ï¸ Building application (30 minute timeout)..."
#             echo "âš ï¸ This may take a while for large applications..."
            
#             # Check if build script exists
#             if ! grep -q '"build"' package.json; then
#               echo "âŒ No build script found in package.json"
#               exit 1
#             fi
            
#             # Build with 30-minute timeout
#             BUILD_START=$(date +%s)
            
#             if timeout 1800 npm run build 2>&1; then
#               BUILD_END=$(date +%s)
#               BUILD_DURATION=$((BUILD_END - BUILD_START))
#               BUILD_MINUTES=$((BUILD_DURATION / 60))
              
#               echo "âœ… Build successful!"
#               echo "â±ï¸  Build time: ${BUILD_DURATION}s (${BUILD_MINUTES}m)"
              
#               # Check build output
#               if [ -d ".next" ]; then
#                 BUILD_SIZE=$(du -sh .next | cut -f1)
#                 echo "ðŸ“¦ Build size: $BUILD_SIZE"
                
#                 # Count pages
#                 PAGE_COUNT=$(find .next/server -name "*.html" 2>/dev/null | wc -l)
#                 echo "ðŸ“„ Pages built: $PAGE_COUNT"
#               fi
#             else
#               BUILD_END=$(date +%s)
#               BUILD_DURATION=$((BUILD_END - BUILD_START))
              
#               echo "âŒ Build failed or timed out after ${BUILD_DURATION}s"
#               echo "ðŸ“‹ Last 20 lines of build output:"
#               tail -20 npm-debug.log 2>/dev/null || echo "No build log found"
              
#               # Rollback
#               if [ -f "$BACKUP_FILE" ]; then
#                 echo "ðŸ”„ Rolling back from backup..."
#                 rm -rf .next node_modules package-lock.json
#                 timeout 300 tar -xzf "$BACKUP_FILE" 2>/dev/null || echo "Rollback failed"
#               fi
              
#               exit 1
#             fi
            
#             # ================================================================
#             # 8. INSTALL PRODUCTION DEPENDENCIES
#             # ================================================================
#             echo ""
#             echo "âš¡ Installing production dependencies (5 minute timeout)..."
            
#             if timeout 300 npm ci --omit=dev --no-audit --no-fund --ignore-scripts; then
#               echo "âœ… Production dependencies installed"
#             else
#               echo "âš ï¸ Production install failed, keeping existing node_modules"
#             fi
            
#             # ================================================================
#             # 9. PM2 SETUP
#             # ================================================================
#             echo ""
#             echo "âš™ï¸ Setting up PM2..."
            
#             # Install PM2 if not present
#             if ! command -v pm2 &> /dev/null; then
#               echo "ðŸ“¦ Installing PM2..."
#               npm install -g pm2 --no-audit --no-fund
#             fi
            
#             # Restart application
#             echo "ðŸ”„ Restarting application..."
            
#             # Stop existing process
#             pm2 delete "$APP_NAME" 2>/dev/null || echo "No existing process found"
            
#             # Start new process with 2-minute timeout
#             echo "ðŸš€ Starting application..."
#             if [ -f ".next/standalone/server.js" ]; then
#               echo "ðŸ” Using standalone build"
#               timeout 120 pm2 start .next/standalone/server.js \
#                 --name "$APP_NAME" \
#                 --log "/var/log/${APP_NAME}.log" \
#                 --time \
#                 -- \
#                 --port=3000 \
#                 --hostname=127.0.0.1
#             else
#               echo "âš¡ Using npm start"
#               timeout 120 pm2 start npm \
#                 --name "$APP_NAME" \
#                 --log "/var/log/${APP_NAME}.log" \
#                 --time \
#                 -- \
#                 start
#             fi
            
#             # Save PM2 config
#             pm2 save 2>/dev/null || echo "PM2 save failed"
            
#             # Setup startup
#             echo "ðŸ”§ Setting up PM2 startup..."
#             pm2 startup 2>/dev/null | tail -1 | sudo bash 2>/dev/null || echo "PM2 startup already configured"
            
#             # ================================================================
#             # 10. HEALTH CHECK (WITH RETRIES)
#             # ================================================================
#             echo ""
#             echo "ðŸ¥ Running health check..."
            
#             MAX_RETRIES=10
#             RETRY_DELAY=10  # seconds
#             HEALTHY=false
            
#             for i in $(seq 1 $MAX_RETRIES); do
#               echo "  Attempt $i/$MAX_RETRIES..."
              
#               if curl -s -f -m 30 http://127.0.0.1:3000 > /dev/null; then
#                 RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" http://127.0.0.1:3000)
#                 echo "âœ… Application is healthy!"
#                 echo "â±ï¸  Response time: ${RESPONSE_TIME}s"
#                 HEALTHY=true
#                 break
#               else
#                 if [ $i -lt $MAX_RETRIES ]; then
#                   echo "  âŒ Health check failed, retrying in ${RETRY_DELAY}s..."
#                   sleep $RETRY_DELAY
#                 fi
#               fi
#             done
            
#             if [ "$HEALTHY" = false ]; then
#               echo "âš ï¸ Health check failed after $MAX_RETRIES attempts"
#               echo "ðŸ“‹ Checking PM2 logs..."
#               timeout 30 pm2 logs "$APP_NAME" --lines 20 2>/dev/null || echo "No logs available"
              
#               # Check if process is running
#               echo "ðŸ” Checking process status..."
#               pm2 status "$APP_NAME" 2>/dev/null || echo "PM2 status unavailable"
#             fi
            
#             # ================================================================
#             # 11. CLEANUP
#             # ================================================================
#             echo ""
#             echo "ðŸ§¹ Cleaning up..."
            
#             # Clean old backups (keep last 7)
#             echo "ðŸ—‘ï¸  Removing old backups..."
#             cd "$BACKUP_DIR"
#             BACKUP_FILES=$(ls -t ${APP_NAME}_backup_*.tar.gz 2>/dev/null | tail -n +8)
            
#             if [ -n "$BACKUP_FILES" ]; then
#               echo "Removing old backups:"
#               echo "$BACKUP_FILES"
#               echo "$BACKUP_FILES" | xargs rm -f 2>/dev/null || true
#             else
#               echo "No old backups to remove"
#             fi
            
#             BACKUP_COUNT=$(ls -1 ${APP_NAME}_backup_*.tar.gz 2>/dev/null | wc -l)
#             echo "ðŸ“¦ Backups retained: $BACKUP_COUNT"
            
#             # Clean npm cache
#             echo "ðŸ§½ Cleaning npm cache..."
#             npm cache clean --force 2>/dev/null || true
            
#             # ================================================================
#             # 12. FINAL STATUS
#             # ================================================================
#             echo ""
#             echo "ðŸŽ‰ðŸŽ‰ðŸŽ‰ DEPLOYMENT COMPLETED SUCCESSFULLY! ðŸŽ‰ðŸŽ‰ðŸŽ‰"
#             echo "================================================"
#             echo ""
#             echo "ðŸ“Š DEPLOYMENT SUMMARY:"
#             echo "  ðŸ“± Application:    $APP_NAME"
#             echo "  ðŸ“ Directory:      $APP_DIR"
#             echo "  ðŸŒ URL:            https://orrelng.com"
#             echo "  ðŸ•’ Start time:     $(date -d @$DEPLOY_START)"
#             echo "  ðŸ•’ End time:       $(date)"
#             DEPLOY_DURATION=$(( $(date +%s) - DEPLOY_START ))
#             DEPLOY_MINUTES=$((DEPLOY_DURATION / 60))
#             echo "  â±ï¸  Total time:    ${DEPLOY_DURATION}s (${DEPLOY_MINUTES}m)"
#             echo "  ðŸ“ Git commit:     $CURRENT_COMMIT"
#             echo "  ðŸ“¦ Node.js:        $(node --version)"
#             echo "  ðŸ“¦ npm:            $(npm --version)"
#             echo ""
            
#             echo "ðŸ“‹ APPLICATION STATUS:"
#             echo "----------------------"
#             timeout 30 pm2 status "$APP_NAME" 2>/dev/null || {
#               echo "  PM2 status unavailable"
#               echo "  Checking process directly..."
#               ps aux | grep -v grep | grep "$APP_NAME" && echo "  âœ… Process is running" || echo "  âš ï¸ Process not found"
#             }
            
#             echo ""
#             echo "âœ… Deployment complete! The application is now live."
#             echo "ðŸ”— Access at: https://orrelng.com"
            
#             # Log deployment
#             DEPLOY_LOG="$BACKUP_DIR/deployments.log"
#             echo "$(date) | SUCCESS | $CURRENT_COMMIT | ${DEPLOY_DURATION}s" >> "$DEPLOY_LOG"
            
#             exit 0