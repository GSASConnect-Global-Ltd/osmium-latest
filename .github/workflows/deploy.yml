# name: Deploy to Production
# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Setup Node.js
#       uses: actions/setup-node@v3
#       with:
#         node-version: '18'
#         cache: 'npm'

#     - name: Install dependencies
#       run: npm ci

#     - name: Run tests (if you have any)
#       run: npm test --if-present

#     - name: Build application
#       run: npm run build

#     - name: Deploy to VPS
#       uses: appleboy/ssh-action@v0.1.6
#       with:
#         host: ${{ secrets.VPS_IP }}
#         username: ${{ secrets.VPS_USER }}
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         # script: |
#         #   cd /var/www/orrel-app
#         #   git pull origin main
#         #   npm ci --production
#         #   npm run build
#         #   pm2 restart ecosystem.config.js
#         #   echo "Deployment completed successfully!"
#         script: |
#             cd /var/www/orrel-app && ./deploy.sh


# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     timeout-minutes: 15
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Setup Node.js
#       uses: actions/setup-node@v3
#       with:
#         node-version: '18'
#         cache: 'npm'

#     - name: Install dependencies
#       run: npm ci

#     - name: Create environment file for build
#       run: |
#         # Create a temporary .env.local for build
#         echo "Creating .env.local for build..."
#         cat > .env.local << EOF
#         # Environment variables needed for build
#         NODE_ENV=production
#         NEXT_PUBLIC_API_BASE_URL=http://localhost:5000
#         # OPENAI_API_KEY is only needed if you use OpenAI during build
#         # If not, you can omit it or use a dummy value
#         EOF
        
#         # Add OPENAI_API_KEY only if it's needed for build
#         if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
#           echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env.local
#         fi

#     - name: Run linting (optional but recommended)
#       run: npm run lint --if-present || true

#     - name: Build application
#       run: npm run build

#     - name: Deploy to VPS
#       uses: appleboy/ssh-action@v0.1.6
#       with:
#         host: ${{ secrets.VPS_IP }}
#         username: ${{ secrets.VPS_USER }}
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script: |
#           set -e  # Exit on error
#           cd /var/www/orrel-app
          
#           echo "ðŸ“¥ Pulling latest code..."
#           git pull origin main
          
#           echo "ðŸ”§ Installing dependencies..."
#           npm ci --omit=dev
          
#           echo "âš™ï¸ Setting up environment..."
#           # Create or update .env.local on server
#           cat > .env.local << 'EOF'
#           NODE_ENV=production
#           PORT=8006
#           NEXT_PUBLIC_API_BASE_URL=http://localhost:5000
#           # OPENAI_API_KEY will be added from secrets below
#           EOF
          
#           # Add secret environment variables
#           echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env.local
          
#           echo "ðŸ—ï¸ Building application..."
#           npm run build
          
#           echo "ðŸ”„ Restarting PM2..."
#           # Use the fixed ecosystem.config.js
#           pm2 delete orrel-app 2>/dev/null || true
#           pm2 start ecosystem.config.js
          
#           echo "ðŸ’¾ Saving PM2 process list..."
#           pm2 save
          
#           echo "âœ… Deployment completed successfully!"
#           echo "ðŸ“Š Check status with: pm2 status"

# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Deploy via SSH
#       uses: appleboy/ssh-action@v0.1.6
#       with:
#         host: ${{ secrets.VPS_IP }}
#         username: ${{ secrets.VPS_USER }}
#         port: 22222
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script: |
#           cd /var/www/orrel-app
#           git pull origin main
#           npm ci --omit=dev
          
#           # Create .env.local with OpenAI key
#           cat > .env.local << EOF
#           NODE_ENV=production
#           PORT=8006
#           # NEXT_PUBLIC_API_BASE_URL=http://localhost:5000
#           OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
#           EOF
          
#           npm run build
#           pm2 restart ecosystem.config.js

# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Setup SSH
#       uses: webfactory/ssh-agent@v0.7.0
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
#     - name: Add VPS to known_hosts
#       run: |
#         # mkdir -p ~/.ssh
#         ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts
    
#     - name: Deploy
#       run: |
#         ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           cd /var/www/orrel-app
#           git pull origin main
#           npm ci --omit=dev
          
#           # Create .env.local with OpenAI key
#           # cat > .env.local << 'EOF'
#           NODE_ENV=production
#           PORT=8006
#           # NEXT_PUBLIC_API_BASE_URL=http://localhost:5000
#           OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
#           EOF
          
#           npm run build
#           pm2 restart ecosystem.config.js
#         "

# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Setup SSH
#       uses: webfactory/ssh-agent@v0.7.0
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
#     - name: Add VPS to known_hosts
#       run: |
#         mkdir -p ~/.ssh
#         ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts
    
#     - name: Deploy
#       run: |
#         ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           set -e
#           cd /var/www/orrel-app
          
#           echo 'Resetting git changes...'
#           git reset --hard HEAD
#           git clean -fd
          
#           echo 'Pulling latest code...'
#           git fetch origin
#           git checkout main
#           git reset --hard origin/main
          
#           echo 'Installing dependencies...'
#           npm ci --omit=dev
          
#           echo 'Creating environment file...'
#           # Simple echo instead of cat with EOF
#           echo 'NODE_ENV=production' > .env.local
#           echo 'PORT=8006' >> .env.local
#           echo 'OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}' >> .env.local
          
#           echo 'Building application...'
#           npm run build
          
#           echo 'Restarting PM2...'
#           pm2 restart ecosystem.config.js
          
#           echo 'âœ… Deployment complete!'
#         "


# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Setup SSH
#       uses: webfactory/ssh-agent@v0.7.0
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
#     - name: Add VPS to known_hosts
#       run: |
#         mkdir -p ~/.ssh
#         ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts
    
#     - name: Deploy
#       run: |
#         ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           set -e
#           cd /var/www/orrel-app
          
#           echo 'Resetting git changes...'
#           git reset --hard HEAD
#           git clean -fd
          
#           echo 'Pulling latest code...'
#           git fetch origin
#           git checkout main
#           git reset --hard origin/main
          
#           echo 'Installing dependencies (including dev dependencies)...'
#           # Remove --omit=dev to include TypeScript
#           npm ci
          
#           echo 'Creating environment file...'
#           echo 'NODE_ENV=production' > .env.local
#           echo 'PORT=8006' >> .env.local
#           echo 'OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}' >> .env.local
          
#           echo 'Building application...'
#           npm run build
          
#           echo 'Restarting PM2...'
#           pm2 restart ecosystem.config.js
          
#           echo 'âœ… Deployment complete!'
#         "


# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main  # Only main branch

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy to VPS
#         run: |
#           set -e
          
#           ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#             set -e
            
#             echo 'ðŸš€ ========== STARTING DEPLOYMENT =========='
            
#             # Changed to orrelng.com directory
#             DEPLOY_DIR=\"/var/www/orrelng.com\"
            
#             if [ ! -d \"\$DEPLOY_DIR\" ]; then
#               echo 'ðŸ“ Creating deployment directory...'
#               sudo mkdir -p \"\$DEPLOY_DIR\"
#               # sudo chown -R gsas-admin:gsas-admin /var/www/orrelng.com
#               # sudo chmod 755 /var/www/orrelng.com
#               sudo chown -R $USER:$USER \"\$DEPLOY_DIR\"
#             fi
            
#             cd \"\$DEPLOY_DIR\"
            
#             echo 'ðŸ“‚ Current directory:'
#             pwd
            
#             # Initialize git if needed
#             if [ ! -d .git ]; then
#               echo 'ðŸ”§ Initializing git repository...'
#               git init
#               git remote add origin https://github.com/${{ github.repository }}.git
#             fi
            
#             # Fetch and reset to latest code (always main branch)
#             echo 'â¬‡ï¸ Fetching latest code from main branch...'
#             git fetch origin
#             git reset --hard origin/main  # Always use main branch
            
#             echo 'ðŸ“ Latest commit:'
#             git log --oneline -1
            
#             # ===== CRITICAL FIX: INSTALL DEPENDENCIES BEFORE CHECKING FILES =====
#             echo 'ðŸ“¦ Installing ALL dependencies...'
#             npm ci
            
#             echo 'ðŸ” Checking TypeScript configuration...'
#             if [ -f tsconfig.json ]; then
#               echo 'ðŸ“„ tsconfig.json found:'
#               cat tsconfig.json | grep -A 10 '"paths"'
#             elif [ -f jsconfig.json ]; then
#               echo 'ðŸ“„ jsconfig.json found:'
#               cat jsconfig.json | grep -A 10 '"paths"'
#             else
#               echo 'âš ï¸ No TypeScript/JavaScript config found!'
#             fi
            
#             echo 'ðŸ” Checking if @/lib directory exists...'
#             find . -type d -name "lib" | head -5
#             ls -la ./lib/ 2>/dev/null || echo 'No ./lib directory'
#             ls -la ./src/lib/ 2>/dev/null || echo 'No ./src/lib directory'
            
#             echo 'ðŸš€ Deploying PRODUCTION environment (main branch only)...'
            
#             # SIMPLIFIED: Use only .env file
#             if [ -f .env ]; then
#               echo 'ðŸ“„ Using .env file'
#               cp .env .env.local
#             else
#               echo 'âš ï¸ Warning: .env file not found!'
#             fi
            
#             # Build for production
#             echo 'ðŸ—ï¸ Building application for production...'
#             NODE_ENV=production npm run build  # Assuming your build script is 'build'
            
#             # Restart PM2 process with orrelng.com name
#             echo 'ðŸ”„ Managing PM2 production process...'
#             pm2 delete orrelng.com 2>/dev/null || true
#             pm2 start npm --name \"orrelng.com\" -- run start -- -p 8006  # Assuming start script is 'start'
            
#             pm2 save
            
#             echo 'ðŸŒ Reloading nginx for orrelng.com...'
#             sudo systemctl reload nginx
            
#             echo 'âœ… ========== DEPLOYMENT COMPLETE =========='
#           "


# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Update Code
#         run: |
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             cd /var/www/orrelng.com || (sudo mkdir -p /var/www/orrelng.com && sudo chown gsas-admin:gsas-admin /var/www/orrelng.com && cd /var/www/orrelng.com)
#             git pull origin main || git clone https://github.com/${{ github.repository }}.git .
#           "

#       - name: Install and Build
#         run: |
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             cd /var/www/orrelng.com
#             npm install --no-optional
#             npm run build
#           "

#       - name: Start Application
#         run: |
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             cd /var/www/orrelng.com
#             pm2 delete orrelng.com 2>/dev/null || true
#             PORT=8006 pm2 start npm --name 'orrelng.com' -- start
#             sudo systemctl reload nginx
#           "

# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Deploy
#         run: |
#           # Add to known_hosts
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts
          
#           # Deploy in one go with keepalive
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             set -e
            
#             echo 'ðŸš€ Starting deployment...'
            
#             # Setup directory
#             sudo mkdir -p /var/www/orrelng.com
#             sudo chown -R gsas-admin:gsas-admin /var/www/orrelng.com
            
#             cd /var/www/orrelng.com
            
#             # Update code
#             if [ -d .git ]; then
#               git pull origin main
#             else
#               git clone https://github.com/${{ github.repository }}.git .
#             fi
            
#             # Install and build
#             echo 'ðŸ“¦ Installing dependencies...'
#             npm install --no-optional
            
#             echo 'ðŸ—ï¸ Building...'
#             npm run build
            
#             # Start app
#             echo 'ðŸ”„ Starting application...'
#             pm2 delete orrelng.com 2>/dev/null || true
#             PORT=8006 pm2 start npm --name 'orrelng.com' -- start
#             pm2 save
            
#             # Reload nginx
#             sudo systemctl reload nginx
            
#             echo 'âœ… Deployment complete!'
#           "

# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy
#         run: |
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             set -e
            
#             echo 'ðŸš€ Starting deployment...'
            
#             # Setup directory
#             DEPLOY_DIR=\"/var/www/orrelng.com\"
#             sudo mkdir -p \"\$DEPLOY_DIR\"
#             sudo chown -R gsas-admin:gsas-admin \"\$DEPLOY_DIR\"
            
#             cd \"\$DEPLOY_DIR\"
            
#             echo 'ðŸ—‘ï¸ Cleaning previous build...'
#             rm -rf .next node_modules package-lock.json
            
#             echo 'ðŸ“¥ Cloning fresh code...'
#             git clone https://github.com/${{ github.repository }}.git . 2>/dev/null || git pull origin main
            
#             echo 'ðŸ“¦ Installing dependencies with exact versions...'
#             # Force clean install
#             npm cache clean --force
#             npm install --legacy-peer-deps
            
#             echo 'ðŸ”§ Checking architecture...'
#             echo \"Node version: \$(node --version)\"
#             echo \"NPM version: \$(npm --version)\"
#             echo \"Architecture: \$(uname -m)\"
#             echo \"Kernel: \$(uname -s)\"
            
#             echo 'ðŸ—ï¸ Building for production on VPS...'
#             # Clear Next.js cache
#             rm -rf /home/gsas-admin/.cache/next-swc
            
#             # Set environment and build
#             NODE_ENV=production npm run build
            
#             echo 'âœ… Build complete!'
            
#             echo 'ðŸ”„ Restarting application...'
#             pm2 delete orrelng.com 2>/dev/null || true
#             PORT=3000 pm2 start npm --name 'orrelng.com' -- start
#             pm2 save
            
#             echo 'ðŸŒ Reloading nginx...'
#             sudo systemctl reload nginx
            
#             echo 'ðŸŽ‰ Deployment complete!'
#           "

# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy
#         run: |
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             set -e
            
#             echo 'ðŸš€ Starting deployment...'
            
#             # Setup directory
#             DEPLOY_DIR=\"/var/www/orrelng.com\"
#             sudo mkdir -p \"\$DEPLOY_DIR\"
#             sudo chown -R gsas-admin:gsas-admin \"\$DEPLOY_DIR\"
            
#             cd \"\$DEPLOY_DIR\"
            
#             echo 'ðŸ“¥ Cloning/updating code...'
#             if [ -d .git ]; then
#               git pull origin main
#             else
#               git clone https://github.com/${{ github.repository }}.git .
#             fi
            
#             echo 'ðŸ“¦ Installing dependencies...'
#             npm install --legacy-peer-deps
            
#             echo 'ðŸ”§ Setting up environment...'
#             # Create .env file with required variables
#             cat > .env.local << 'EOF'
#             PORT=8006
#             OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
#             NODE_ENV=production
#             EOF
            
#             # Also create .env for build
#             cp .env.local .env
            
#             echo 'ðŸ—ï¸ Building application...'
#             NODE_ENV=production npm run build
            
#             echo 'ðŸš€ Starting application...'
#             pm2 delete orrelng.com 2>/dev/null || true
#             pm2 start npm --name 'orrelng.com' -- start
            
#             echo 'âœ… Deployment complete!'
#           "

# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy
#         run: |
#           # Single SSH command with simple commands
#           ssh -p 22222 -o ServerAliveInterval=30 gsas-admin@${{ secrets.VPS_IP }} "
#             set -e
#             echo 'ðŸš€ Starting deployment...'
            
#             # Setup
#             sudo mkdir -p /var/www/orrelng.com
#             sudo chown -R gsas-admin:gsas-admin /var/www/orrelng.com
#             cd /var/www/orrelng.com
            
#             # Update code
#             if [ -d .git ]; then
#               git pull origin main
#             else
#               git clone https://github.com/${{ github.repository }}.git .
#             fi
            
#             # Install
#             npm install --legacy-peer-deps
            
#             # Environment
#             echo 'PORT=8006' > .env
#             echo 'NODE_ENV=production' >> .env
#             cp .env .env.local
            
#             # Build
#             NODE_ENV=production npm run build
            
#             # Start
#             pm2 delete orrelng.com 2>/dev/null || true
#             pm2 start npm --name 'orrelng.com' -- start -- -p 8006
            
#             echo 'âœ… Done!'
#           "


# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy to VPS
#         run: |
#           set -e
          
#           ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#             set -e
            
#             echo 'ðŸš€ ========== STARTING DEPLOYMENT =========='
            
#             DEPLOY_DIR=\"/var/www/orrelng.com\"
            
#             if [ ! -d \"\$DEPLOY_DIR\" ]; then
#               echo 'ðŸ“ Creating deployment directory...'
#               sudo mkdir -p \"\$DEPLOY_DIR\"
#               sudo chown -R $USER:$USER \"\$DEPLOY_DIR\"
#             fi
            
#             cd \"\$DEPLOY_DIR\"
            
#             echo 'ðŸ“‚ Current directory:'
#             pwd
            
#             # Initialize git if needed
#             if [ ! -d .git ]; then
#               echo 'ðŸ”§ Initializing git repository...'
#               git init
#               git remote add origin https://github.com/${{ github.repository }}.git
#             fi
            
#             # Fetch and reset to latest code
#             echo 'â¬‡ï¸ Fetching latest code...'
#             git fetch origin
#             git reset --hard origin/main
            
#             echo 'ðŸ“ Latest commit:'
#             git log --oneline -1
            
#             echo 'ðŸ“¦ Installing dependencies...'
#             npm ci
            
#             echo 'ðŸ—ï¸ Building application...'
            
#             # SIMPLIFIED: Use only .env file
#             if [ -f .env ]; then
#               echo 'ðŸ“„ Using .env file'
#               cp .env .env.local
#             else
#               echo 'âš ï¸ Warning: .env file not found!'
#               echo 'PORT=8006' > .env.local
#             fi
            
#             # Build for production
#             echo 'ðŸš€ Building for production...'
#             NODE_ENV=production npm run build
            
#             # Restart PM2 process
#             echo 'ðŸ”„ Managing PM2 process...'
#             pm2 delete orrelng.com 2>/dev/null || true
#             pm2 start npm --name \"orrelng.com\" -- start 
            
#             pm2 save
            
#             echo 'ðŸŒ Reloading nginx...'
#             sudo systemctl reload nginx
            
#             echo 'âœ… ========== DEPLOYMENT COMPLETE =========='
#           "

# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Test SSH connection
#         run: |
#           ssh -p 22222 -T ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "echo 'SSH connection successful'"

#       - name: Deploy to VPS
#         run: |
#           ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} '
#             set -e
#             echo "ðŸš€ Starting deployment..."
            
#             DEPLOY_DIR="/var/www/orrelng.com"
            
#             # Setup directory
#             sudo mkdir -p "$DEPLOY_DIR"
#             sudo chown -R $USER:$USER "$DEPLOY_DIR"
            
#             cd "$DEPLOY_DIR"
            
#             # Get latest code
#             if [ -d .git ]; then
#               git pull origin main
#             else
#               git clone https://github.com/${{ github.repository }}.git .
#             fi
            
#             # Install dependencies
#             npm ci
            
#             # Create environment file
#             cat > .env.local << END
#             PORT=3000
#             NODE_ENV=production
#             END
            
#             # Build
#             npm run build
            
#             # Start with PM2
#             pm2 delete orrelng.com 2>/dev/null || true
#             pm2 start npm --name "orrelng.com" -- start -- -p 8006
            
            
#             echo "âœ… Deployment complete!"
#           '

# name: Deploy to orrelng.com

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     timeout-minutes: 30

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy to VPS
#         run: |
#           # Use nohup to run commands in background
#           ssh -p 22222 -o ConnectTimeout=300 -o ServerAliveInterval=30 -o ServerAliveCountMax=3 gsas-admin@${{ secrets.VPS_IP }} "
#             set -e
#             echo 'ðŸš€ Starting deployment...'
            
#             cd /var/www/orrelng.com
            
#             # Quick code update
#             git pull origin main
            
#             # Install deps
#             npm ci
            
#             # Create env file
#             echo 'PORT=8006' > .env.local
#             echo 'NODE_ENV=production' >> .env.local
#             echo 'OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}' >> .env.local
            
#             # Build with timeout
#             timeout 300 npm run build || {
#               echo 'Build took too long, continuing anyway...'
#             }
            
#             # Start app
#             pm2 delete orrelng.com 2>/dev/null || true
#             pm2 start npm --name 'orrelng.com' -- start -- -p 8006
            
#             echo 'âœ… Deployment complete!'
#             exit 0
#           "

# name: Deploy to orrelng.com

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     timeout-minutes: 30

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy to VPS
#         run: |
#           ssh -p 22222 -o ConnectTimeout=300 gsas-admin@${{ secrets.VPS_IP }} "
#             set -e
            
#             echo 'ðŸš€ ========== STARTING DEPLOYMENT =========='
            
#             # Setup directory
#             DEPLOY_DIR=\"/var/www/orrelng.com\"
#             sudo mkdir -p \"\$DEPLOY_DIR\"
#             sudo chown -R gsas-admin:gsas-admin \"\$DEPLOY_DIR\"
            
#             cd \"\$DEPLOY_DIR\"
#             echo 'ðŸ“‚ Directory: \$(pwd)'
            
#             # Clean any existing build
#             # echo 'ðŸ§¹ Cleaning previous build...'
#             # rm -rf .next node_modules package-lock.json 2>/dev/null || true
            
#             # Clone or update
#             if [ -d .git ]; then
#               echo 'â¬‡ï¸ Pulling latest code...'
#               git pull origin main
#             else
#               echo 'ðŸ“¥ Cloning repository...'
#               git clone https://github.com/${{ github.repository }}.git .
#             fi
            
#             # Install dependencies
#             echo 'ðŸ“¦ Installing dependencies...'
#             npm ci
            
#             # # Create environment file (port 8006 as shown in your logs)
#             # echo 'ðŸ”§ Creating .env.local...'
#             # # cat > .env.local << 'EOF'
#             # PORT=8006
#             # NODE_ENV=production
#             # OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
#             # EOF

#             echo 'PORT=8006' > .env.local
#             echo 'NODE_ENV=production' >> .env.local
#             echo 'OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}' >> .env.local
            
#             # Build with timeout
#             timeout 300 npm run build || {
#               echo 'Build took too long, continuing anyway...'
#             }
            
#             # echo 'ðŸ“„ Environment file created:'
#             # cat .env.local | grep -v OPENAI_API_KEY
            
#             # # Build the application
#             # echo 'ðŸ—ï¸ Building Next.js application...'
#             # npm run build
            
#             # Verify build exists
#             echo 'ðŸ” Verifying build...'
#             if [ -d .next ]; then
#               echo 'âœ… Build directory found:'
#               ls -la .next/
#             else
#               echo 'âŒ ERROR: No .next directory after build!'
#               exit 1
#             fi
            
#             # Start with PM2
#             echo 'ðŸ”„ Starting with PM2...'
#             pm2 delete orrel-app 2>/dev/null || true
#             pm2 start npm --name \"orrel-app\" -- start -- -p 8006
            
#             # Save PM2 config
#             pm2 save
            
#             echo 'âœ… ========== DEPLOYMENT COMPLETE =========='
#             echo 'ðŸŒ App should be running on port 8006'
#           "

# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Setup Node.js
#       uses: actions/setup-node@v3
#       with:
#         node-version: '18'
#         cache: 'npm'

#     # - name: Install dependencies
#     #   run: npm ci

#     # - name: Build application
#     #   run: npm run build

#     - name: Deploy to VPS
#       uses: appleboy/ssh-action@v0.1.6
#       with:
#         host: ${{ secrets.VPS_IP }}
#         username: ${{ secrets.VPS_USER }}
#         port: 22222
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script: |
#           # Export OpenAI API key as environment variable
#           export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
          
#           # Go to deployment directory
#           cd /var/www/orrelng.com
          
#           # Make sure deploy.sh is executable
#           chmod +x deploy.sh
          
#           # Run deployment script
#           ./deploy.sh
          
#           echo "ðŸŒ Deployment complete! App running on port 8006"


# name: Deploy to Production

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Setup Node.js
#       uses: actions/setup-node@v3
#       with:
#         node-version: '18'
#         cache: 'npm'

#     - name: Set up SSH with custom port
#       uses: webfactory/ssh-agent@v0.7.0
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#     - name: Add VPS to known_hosts with port 22222
#       run: |
#         mkdir -p ~/.ssh
#         chmod 700 ~/.ssh
#         # Add with custom port syntax
#         ssh-keyscan -p 22222 -H ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts
#         chmod 600 ~/.ssh/known_hosts

#     - name: Deploy to VPS via SSH
#       run: |
#         echo "ðŸš€ Deploying via SSH port 22222..."
        
#         # Deploy using SSH with custom port
#         ssh -p 22222 -o ConnectTimeout=30 -o ServerAliveInterval=60 \
#           ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           echo 'ðŸ“ Changing to app directory...'
#           cd /var/www/orrel-app
          
#           echo 'ðŸ“¥ Pulling latest code...'
#           git fetch origin
#           git reset --hard origin/main
#           git clean -fd
          
#           # echo 'ðŸ“¦ Installing dependencies...'
#           # npm ci --omit=dev
          
#           # echo 'ðŸ—ï¸ Building application...'
#           # npm run build
          
#           echo 'ðŸ”„ Restarting PM2...'
#           cd /var/www/orrel-app && ./deploy.sh
#           # pm2 delete orrel-app 2>/dev/null || true
#           # pm2 start ecosystem.config.js
#           # pm2 save
          
#           echo 'âœ… Deployment completed on VPS!'
#         "
        
#         echo "ðŸŽ‰ GitHub Actions deployment completed!"


#         # Clean up any corrupted node_modules
# if [ -d "node_modules" ]; then
#     echo "ðŸ§¹ Cleaning node_modules..."
#     rm -rf node_modules
# fi

# # Clean npm cache
# echo "ðŸ§¹ Cleaning npm cache..."
# npm cache clean --force

name: Deploy Next.js Frontend

on:
  push:
    branches: [main]
    paths:
      - 'orrel-app/**'  # Only deploy when frontend changes

jobs:
  deploy:
    runs-on: ubuntu-latest
    # environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'  # Match your server's Node version
        cache: 'npm'
        cache-dependency-path: 'orrel-app/package-lock.json'

    - name: Build and test locally (optional)
      run: |
        cd orrel-app
        echo "ðŸ”§ Installing dependencies..."
        npm ci --omit=dev
        echo "ðŸ—ï¸ Building application..."
        npm run build
        echo "âœ… Build successful!"
      if: false  # Set to true if you want to test build before deploy

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Add VPS to known_hosts
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan -p 22222 -H ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts
        chmod 600 ~/.ssh/known_hosts

    - name: Deploy to VPS
      run: |
        echo "ðŸš€ Deploying to production..."
        
        # Execute deployment on server
        ssh -p 22222 \
          -o ConnectTimeout=30 \
          -o ServerAliveInterval=60 \
          -o StrictHostKeyChecking=no \
          ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} << 'EOF'
        set -e
        
        echo "ðŸ”’ Starting secure deployment..."
        
        # ============================================
        # CONFIGURATION
        # ============================================
        APP_NAME="orrel-app"
        APP_DIR="/var/www/orrel-app"
        BACKUP_DIR="/home/admin-gsas/backups"
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        # ============================================
        
        # 1. Ensure Node.js is available (already verified)
        echo "ðŸ“Š Node.js: $(node --version)"
        echo "ðŸ“Š npm: $(npm --version)"
        
        # 2. Create backup directory
        mkdir -p "$BACKUP_DIR"
        
        # 3. Navigate to app directory
        cd "$APP_DIR"
        echo "ðŸ“ Working in: $(pwd)"
        
        # 4. Backup current version
        echo "ðŸ“¦ Creating backup..."
        if [ -d ".next" ] || [ -d "node_modules" ]; then
          tar czf "$BACKUP_DIR/${APP_NAME}_backup_$TIMESTAMP.tar.gz" \
            .next \
            node_modules \
            package-lock.json \
            2>/dev/null || echo "Backup created"
        else
          echo "First deployment, skipping backup"
        fi
        
        # 5. Update code
        echo "â¬‡ï¸ Pulling latest code..."
        if [ -d ".git" ]; then
          git fetch origin
          git reset --hard origin/main
          git clean -fd
          echo "âœ… Code updated"
        else
          echo "âŒ Not a git repository"
          exit 1
        fi
        
        # 6. Install dependencies securely
        echo "ðŸ“¦ Installing dependencies..."
        
        # Clean previous builds
        rm -rf .next
        
        # Check for package-lock.json
        if [ ! -f "package-lock.json" ]; then
          echo "âš ï¸ package-lock.json not found. Generating..."
          npm install --package-lock-only --omit=dev
        fi
        
        # Clean install with exact versions
        npm ci --omit=dev --audit
        
        echo "âœ… Dependencies installed"
        
        # 7. Build Next.js application
        echo "ðŸ—ï¸ Building Next.js application..."
        
        # Set production environment
        export NODE_ENV=production
        export NEXT_TELEMETRY_DISABLED=1
        
        # Run build
        if npm run build; then
          echo "âœ… Build successful"
          BUILD_SIZE=$(du -sh .next | cut -f1)
          echo "ðŸ“¦ Build size: $BUILD_SIZE"
        else
          echo "âŒ Build failed"
          exit 1
        fi
        
        # 8. Setup PM2
        echo "âš™ï¸ Configuring PM2..."
        
        # Check if PM2 is installed
        if ! command -v pm2 &> /dev/null; then
          echo "ðŸ“¦ Installing PM2..."
          npm install -g pm2
        fi
        
        # Stop existing process
        echo "ðŸ”„ Restarting application..."
        pm2 delete "$APP_NAME" 2>/dev/null || echo "No existing process"
        
        # Start Next.js
        # Option A: If using output: 'standalone' in next.config.js
        if [ -f ".next/standalone/server.js" ]; then
          echo "ðŸš€ Starting standalone Next.js..."
          pm2 start .next/standalone/server.js --name "$APP_NAME" \
            -- \
            --port 3000 \
            --hostname 127.0.0.1
        else
          # Option B: Regular Next.js start
          echo "ðŸš€ Starting Next.js on port 3000..."
          pm2 start npm --name "$APP_NAME" -- \
            run start -- --port 3000 --hostname 127.0.0.1
        fi
        
        # 9. Save PM2 configuration
        pm2 save
        
        # 10. Setup PM2 startup (if not already)
        pm2 startup 2>/dev/null || echo "PM2 startup already configured"
        
        # 11. Cleanup old backups (keep last 3)
        echo "ðŸ§¹ Cleaning up old backups..."
        cd "$BACKUP_DIR"
        ls -t ${APP_NAME}_backup_*.tar.gz 2>/dev/null | tail -n +4 | xargs -r rm -f || echo "No old backups"
        
        # 12. Verify deployment
        echo ""
        echo "âœ… DEPLOYMENT COMPLETED!"
        echo "========================="
        echo "ðŸ“Š Application Status:"
        pm2 status "$APP_NAME"
        echo ""
        echo "ðŸŒ Health check (waiting 5 seconds)..."
        sleep 5
        if curl -s -f http://127.0.0.1:3000 > /dev/null; then
          echo "âœ… Application is healthy on port 3000"
        else
          echo "âš ï¸  Warning: Application not responding on port 3000"
          echo "Checking PM2 logs..."
          pm2 logs "$APP_NAME" --lines 10 --raw 2>/dev/null || echo "No logs available"
        fi
        
        # 13. Final status
        echo ""
        echo "ðŸŽ‰ Orrel frontend deployed successfully!"
        echo "ðŸ”— Access via: https://orrelng.com"
        EOF
        
        echo "ðŸŽ‰ GitHub Actions deployment completed!"